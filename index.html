<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MySword iOS + AI Assistente Teol√≥gico</title>
<style>
/* ================================================= */
/* 1. FOTO DE PERFIL E SELETORES                    */
/* ================================================= */
.perfil-area {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.3);
    background-color: #333;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    cursor: pointer;
    flex-shrink: 0;
    background-image: url('https://cdn-icons-png.flaticon.com/512/3135/3135715.png');
}

.ai-selector-container, .mode-selector-container {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-right: 10px;
}

.ai-selector, .mode-selector {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 15px;
    padding: 5px 12px;
    color: white;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    transition: all 0.3s;
    min-width: 120px;
    justify-content: space-between;
}

.ai-selector:hover, .mode-selector:hover {
    background: rgba(255,255,255,0.15);
    transform: scale(1.02);
}

.ai-selector:active, .mode-selector:active {
    transform: scale(0.98);
}

.ai-selector .ai-icon, .mode-selector .mode-icon {
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    border-radius: 50%;
}

.ai-selector .ai-name, .mode-selector .mode-name {
    flex: 1;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.ai-selector .ai-arrow, .mode-selector .mode-arrow {
    font-size: 10px;
    opacity: 0.7;
}

/* Dropdowns */
.ai-dropdown, .mode-dropdown {
    display: none;
    position: absolute;
    top: 50px;
    background: rgba(40, 40, 42, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    z-index: 10001;
    min-width: 200px;
    max-width: 250px;
    overflow: hidden;
    animation: dropdownFade 0.2s ease;
}

.ai-dropdown { left: 10px; }
.mode-dropdown { left: 170px; }

@keyframes dropdownFade {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.ai-dropdown.show, .mode-dropdown.show {
    display: block;
}

.ai-option, .mode-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    color: white;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.ai-option:last-child, .mode-option:last-child {
    border-bottom: none;
}

.ai-option:hover, .mode-option:hover {
    background: rgba(255,255,255,0.1);
}

.ai-option.selected, .mode-option.selected {
    background: rgba(10, 132, 255, 0.2);
    border-left: 3px solid #0a84ff;
}

.ai-option .option-icon, .mode-option .option-icon {
    font-size: 16px;
    width: 24px;
    text-align: center;
}

.ai-option .option-name, .mode-option .option-name {
    flex: 1;
    font-weight: 500;
}

.ai-option .option-status {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 8px;
    font-weight: bold;
}

.status-available { background: #30d158; color: white; }
.status-warning { background: #ff9f0a; color: black; }
.status-unavailable { background: #ff453a; color: white; }
.status-offline { background: #8e8e93; color: white; }

/* Badges para cada IA */
.badge-gemini { background: #4285F4; color: white; }
.badge-mistral { background: #6c47ff; color: white; }
.badge-deepseek { background: #1a5fff; color: white; }
.badge-groq { background: #f55325; color: white; }

/* ================================================= */
/* 2. CONFIGURA√á√ïES GERAIS E CORRE√á√ïES               */
/* ================================================= */
.altbookname, .eng, .trans, .ref-eng, span[lang="en"], .splitactive, .splitinactive, .currentx { display: none !important; }
.tag { display: none !important; }
script, style { display: none !important; }

:root {
    --font-sz: 18px;
    --bg: #000000;
    --txt: #ffffff;
    --header-bg: rgba(28,28,30,0.85);
    --chat-bg: rgba(30,30,32,0.98);
    --msg-ai: #2c2c2e;
    --msg-user: #0a84ff;
    --border: #38383a;
    --input-bg: rgba(118,118,128,0.24);
    --active-color: #0a84ff;
    --primary: #1f6feb;
    --accent: #f0883e;
    --gemini: #4285F4;
    --mistral: #6c47ff;
    --deepseek: #1a5fff;
    --groq: #f55325;
    --warning: #ff6b35;
}

body {
    margin: 0;
    padding: 0 10px 60px 10px !important;
    background-color: var(--bg);
    color: var(--txt);
    font-family: Georgia, 'Times New Roman', Times, serif;
    overflow-x: hidden;
    background-position: center center;
    background-repeat: no-repeat;
    background-size: cover;
    background-attachment: fixed;
    background-blend-mode: darken;
    transition: background-image .5s ease;
}

#espaco-topo { width: 100%; height: 115px; display: block; transition: height 0.2s; }

div:not(#header-ai *), p, span, li, button:not(#header-ai button), input {
    font-size: var(--font-sz) !important;
    line-height: 1.25 !important;
    margin-bottom: 4px;
}

p, div, span, h1, h2, h3 { text-shadow: 0 1px 2px rgba(0,0,0,.8); }

/* ================================================= */
/* 3. CORES E MARCA√á√ïES                              */
/* ================================================= */
h1, h2, h3 { color: #0a84ff !important; border-bottom: 1px solid var(--border); margin-top: 5px; }
a { color: #0a84ff !important; text-decoration: none; }
.verno { color: #0a84ff !important; font-weight: bold; }

.add { font-style: italic; color: #aaaaaa; display: inline !important; }
.wjc { color: #ff453a; display: inline !important; }
.red { color: #ff453a !important; display: inline !important; }

.orange { color: #e67e00 !important; }
.brown { color: #ae5819 !important; }
.green { color: #00a300 !important; }
.blue { color: #4343fa !important; }
.yellow { color: #cccc50 !important; }

/* ================================================= */
/* 4. CABE√áALHO E INTERFACE                          */
/* ================================================= */
#header-ai {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background-color: var(--header-bg);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-bottom: 1px solid rgba(255,255,255,.1);
    z-index: 9000;
    display: flex;
    flex-direction: column;
    padding: 6px 10px;
    gap: 6px;
    height: auto;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    transition: transform 0.2s;
}

.ico { width: 16px; height: 16px; fill: currentColor; display: inline-block; vertical-align: middle; }

.top-row { 
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    position: relative;
}

.top-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.top-controls { 
    display: flex; 
    gap: 8px; 
    align-items: center; 
    margin-left: auto;
}
.btn-top {
    background: rgba(255,255,255,.1);
    border: none;
    color: #fff;
    cursor: pointer;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: transform .1s;
}
.btn-top:active { background: rgba(255,255,255,.3); transform: scale(.95); }

.row-main { display: flex; width: 100%; gap: 8px; align-items: center; }
.input-wrapper { flex: 1; display: flex; align-items: center; background: var(--input-bg); border-radius: 8px; padding: 0 8px; height: 32px; }
.input-ai { flex: 1; height: 100%; border: none; background: 0 0; color: #fff; outline: none; font-size: 15px !important; }
.btn-send { width: 32px; height: 32px; border: none; background: #0a84ff; color: #fff; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

/* ================================================= */
/* 5. JANELA DE CHAT                                 */
/* ================================================= */
#janela-chat {
    display: none;
    position: fixed;
    top: 120px;
    left: 10px;
    right: 10px;
    bottom: 20px;
    background: var(--chat-bg);
    backdrop-filter: blur(40px);
    -webkit-backdrop-filter: blur(40px);
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,.15);
    box-shadow: 0 20px 50px rgba(0,0,0,.6);
    z-index: 9999;
    flex-direction: column;
    animation: slideUp .3s cubic-bezier(.2,.8,.2,1);
}
.btn-close-ios {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 28px;
    height: 28px;
    background: rgba(60,60,67,.6);
    border-radius: 50%;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10001;
    backdrop-filter: blur(10px);
}
.btn-close-ios svg { width: 12px; height: 12px; fill: #ebebf5; }
@keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
#chat-content { flex: 1; overflow-y: auto; padding: 15px; margin-top: 5px; }
.msg {
    padding: 10px 14px;
    border-radius: 16px;
    margin-bottom: 10px;
    display: block;
    font-size: 15px !important;
    max-width: 92%;
    color: #fff !important;
    line-height: 1.4;
}
.msg-user { background: #0a84ff; text-align: right; margin-left: auto; border-bottom-right-radius: 4px; }
.msg-ai { background: #2c2c2e; text-align: left; margin-right: auto; border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,.05); }
.btn-copy {
    width: 100%;
    margin-top: 10px;
    padding: 12px;
    background: #30d158;
    color: #fff !important;
    border: none;
    border-radius: 14px;
    font-weight: 700;
    font-size: 14px !important;
}
#area-notas {
    flex: 1;
    width: 100%;
    background: rgba(0,0,0,0.2);
    color: #fff !important;
    font-size: 17px;
    padding: 12px;
    border: 1px solid rgba(255,255,255,.1);
    border-radius: 14px;
    resize: none;
    outline: none;
    font-family: sans-serif;
}

/* ================================================= */
/* 6. MODAL DE CONFIGURA√á√ÉO DA API                   */
/* ================================================= */
.modal-ios {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,.9);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
.modal-content-ios {
    background: #1c1c1e;
    border-radius: 20px;
    padding: 20px;
    max-width: 500px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    border: 1px solid rgba(255,255,255,.1);
    color: white;
}
.modal-header-ios {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.modal-header-ios h3 { color: var(--accent); margin: 0; border: none; }
.close-btn-ios {
    background: none;
    border: none;
    color: #8b949e;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
}
.api-option-ios {
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 2px solid #333;
    background: #2c2c2e;
    cursor: pointer;
    transition: all .3s;
}
.api-option-ios.selected {
    border-color: var(--accent);
    background: #3a3a3c;
}
.api-option-ios.gemini { border-left: 4px solid var(--gemini); }
.api-option-ios.mistral { border-left: 4px solid var(--mistral); }
.api-option-ios.deepseek { border-left: 4px solid var(--deepseek); }
.api-option-ios.groq { border-left: 4px solid var(--groq); }
.modal-input-ios {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border-radius: 8px;
    border: 1px solid #444;
    background: #1c1c1e;
    color: white;
    font-size: 14px;
}
.modal-btn-ios {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 10px;
    background: var(--primary);
    color: white;
    font-weight: bold;
    margin-top: 10px;
    cursor: pointer;
}
.modal-btn-ios.secondary { background: #444; }
.modal-btn-ios.accent { background: var(--accent); color: #000; }
.modal-btn-ios.warning { background: var(--warning); color: white; }
.key-item-ios {
    background: #2c2c2e;
    padding: 10px;
    border-radius: 8px;
    margin: 5px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.key-status { font-size: 12px; padding: 3px 8px; border-radius: 10px; font-weight: bold; }
.status-valid { background: #238636; color: white; }
.status-invalid { background: #da3633; color: white; }
.status-warning { background: #ff6b35; color: white; }
.status-offline { background: #8e8e93; color: white; }
.auto-config-results {
    background: #2c2c2e;
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
    border-left: 4px solid var(--accent);
}
.auto-config-title {
    color: var(--accent);
    font-weight: bold;
    margin-bottom: 10px;
    font-size: 14px;
}
.quota-warning {
    background: rgba(255, 107, 53, 0.1);
    border: 1px solid var(--warning);
    border-radius: 10px;
    padding: 12px;
    margin: 15px 0;
    color: #ff9c7c;
}
.quota-warning h4 {
    color: var(--warning);
    margin: 0 0 8px 0;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.api-recommendation {
    background: rgba(26, 95, 255, 0.1);
    border: 1px solid var(--deepseek);
    border-radius: 10px;
    padding: 12px;
    margin: 15px 0;
}
.api-recommendation h4 {
    color: var(--deepseek);
    margin: 0 0 8px 0;
    font-size: 14px;
}

/* ================================================= */
/* 7. LOADING ANIMATION                              */
/* ================================================= */
.loading-ios {
    display: inline-flex;
    gap: 5px;
    padding: 15px;
}
.loading-ios span {
    width: 8px;
    height: 8px;
    background: var(--accent);
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
}
.loading-ios span:nth-child(1) { animation-delay: -.32s; }
.loading-ios span:nth-child(2) { animation-delay: -.16s; }
@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

/* ================================================= */
/* 8. SELE√á√ÉO DE VERS√çCULOS                          */
/* ================================================= */
.verse-selected {
    background: rgba(10, 132, 255, 0.3) !important;
    border: 1px solid #0a84ff !important;
    border-radius: 4px;
    transition: all 0.3s;
}

/* ================================================= */
/* 9. BADGES DE STATUS                               */
/* ================================================= */
.badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: bold;
    margin-left: 6px;
}
.badge-success { background: #238636; color: white; }
.badge-warning { background: #ff6b35; color: white; }
.badge-error { background: #da3633; color: white; }
.badge-info { background: #1a5fff; color: white; }
</style>
</head>
<body>

<div id="espaco-topo"></div>

<!-- HEADER PRINCIPAL -->
<div id="header-ai" onclick="event.stopPropagation()">
    <div class="top-row">
        <div class="top-left">
            <div class="perfil-area" title="Seu Perfil" onclick="event.stopPropagation()"></div>
            
            <!-- SELETOR DE IA -->
            <div class="ai-selector-container">
                <div class="ai-selector" onclick="toggleAIDropdown(event)" id="ai-selector">
                    <div class="ai-icon" id="ai-current-icon">‚ú®</div>
                    <div class="ai-name" id="ai-current-name">Gemini</div>
                    <div class="ai-arrow">‚ñº</div>
                </div>
                
                <!-- DROPDOWN DE SELE√á√ÉO DE IA -->
                <div class="ai-dropdown" id="ai-dropdown">
                    <div class="ai-option" onclick="selectAI('gemini')" id="ai-option-gemini">
                        <div class="option-icon">‚ú®</div>
                        <div class="option-name">Gemini</div>
                        <div class="option-status status-warning" id="ai-status-gemini">BAIXA COTA</div>
                    </div>
                    <div class="ai-option" onclick="selectAI('mistral')" id="ai-option-mistral">
                        <div class="option-icon">üå™Ô∏è</div>
                        <div class="option-name">Mistral</div>
                        <div class="option-status status-available" id="ai-status-mistral">20/MIN</div>
                    </div>
                    <div class="ai-option" onclick="selectAI('deepseek')" id="ai-option-deepseek">
                        <div class="option-icon">üß†</div>
                        <div class="option-name">DeepSeek</div>
                        <div class="option-status status-available" id="ai-status-deepseek">ILIMITADO</div>
                    </div>
                    <div class="ai-option" onclick="selectAI('groq')" id="ai-option-groq">
                        <div class="option-icon">ü¶ô</div>
                        <div class="option-name">Llama (Groq)</div>
                        <div class="option-status status-available" id="ai-status-groq">500/DIA</div>
                    </div>
                </div>
            </div>
            
            <!-- SELETOR DE MODO -->
            <div class="mode-selector-container">
                <div class="mode-selector" onclick="toggleModeDropdown(event)" id="mode-selector">
                    <div class="mode-icon" id="mode-current-icon">üëÅÔ∏è</div>
                    <div class="mode-name" id="mode-current-name">Vis√£o Geral</div>
                    <div class="mode-arrow">‚ñº</div>
                </div>
                
                <!-- DROPDOWN DE SELE√á√ÉO DE MODO -->
                <div class="mode-dropdown" id="mode-dropdown">
                    <div class="mode-option" onclick="selectMode('visao')" id="mode-option-visao">
                        <div class="option-icon">üëÅÔ∏è</div>
                        <div class="option-name">Vis√£o Geral</div>
                    </div>
                    <div class="mode-option" onclick="selectMode('esboco')" id="mode-option-esboco">
                        <div class="option-icon">üìù</div>
                        <div class="option-name">Esbo√ßo</div>
                    </div>
                    <div class="mode-option" onclick="selectMode('dicionario')" id="mode-option-dicionario">
                        <div class="option-icon">üìö</div>
                        <div class="option-name">Dicion√°rio</div>
                    </div>
                    <div class="mode-option" onclick="selectMode('exegese')" id="mode-option-exegese">
                        <div class="option-icon">üî¨</div>
                        <div class="option-name">Exegese</div>
                    </div>
                    <div class="mode-option" onclick="selectMode('aplicacao')" id="mode-option-aplicacao">
                        <div class="option-icon">üí°</div>
                        <div class="option-name">Aplica√ß√£o</div>
                    </div>
                    <div class="mode-option" onclick="selectMode('contexto')" id="mode-option-contexto">
                        <div class="option-icon">üèõÔ∏è</div>
                        <div class="option-name">Contexto Hist√≥rico</div>
                    </div>
                    <div class="mode-option" onclick="selectMode('thompson')" id="mode-option-thompson">
                        <div class="option-icon">‚õìÔ∏è</div>
                        <div class="option-name">Thompson</div>
                    </div>
                    <div class="mode-option" onclick="selectMode('personagem')" id="mode-option-personagem">
                        <div class="option-icon">üë§</div>
                        <div class="option-name">Personagens</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="top-controls">
            <button class="btn-top" onclick="showApiModal(); event.stopPropagation()" title="Configurar IA">üîß</button>
            <button class="btn-top" onclick="abrirNotas(); event.stopPropagation()" title="Notas & Telegraph">üìù</button>
            <button class="btn-top" onclick="mudarFonte(-1); event.stopPropagation()">A-</button>
            <button class="btn-top" onclick="mudarFonte(1); event.stopPropagation()">A+</button>
        </div>
    </div>
    
    <div class="row-main">
        <div class="input-wrapper" onclick="event.stopPropagation()">
            <svg class="ico" viewBox="0 0 24 24" style="color:#8e8e93;margin-right:5px">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            <input type="text" id="prompt-input" class="input-ai" placeholder="Pergunte sobre teologia assembleiana..." 
                   onkeydown="if(event.key==='Enter')enviar(); event.stopPropagation()" 
                   onclick="event.stopPropagation()">
        </div>
        <button class="btn-send" onclick="enviar(); event.stopPropagation()">‚û§</button>
    </div>
</div>

<!-- JANELA DE CHAT -->
<div id="janela-chat" onclick="event.stopPropagation()">
    <button class="btn-close-ios" onclick="fechar('janela-chat'); event.stopPropagation()" title="Fechar">‚úï</button>
    <div id="chat-content"></div>
</div>

<!-- MODAL DE CONFIGURA√á√ÉO DA API -->
<div id="api-modal-ios" class="modal-ios" onclick="if(event.target===this) hideApiModal();">
    <div class="modal-content-ios" onclick="event.stopPropagation()">
        <div class="modal-header-ios">
            <h3>üîë Configurar Chaves de IA</h3>
            <button class="close-btn-ios" onclick="hideApiModal()">√ó</button>
        </div>
        
        <div class="quota-warning">
            <h4>‚ö†Ô∏è ATEN√á√ÉO: Limites de Cota</h4>
            <p style="font-size: 12px; margin: 0; color: #ff9c7c;">
                ‚Ä¢ <strong>Gemini:</strong> 20 req/dia (cota muito baixa)<br>
                ‚Ä¢ <strong>Mistral:</strong> 20 req/min (melhor op√ß√£o)<br>
                ‚Ä¢ <strong>DeepSeek:</strong> Sem limites claros (recomendado)<br>
                ‚Ä¢ <strong>Groq:</strong> ~500 req/dia (boa alternativa)
            </p>
        </div>
        
        <div class="api-recommendation">
            <h4>‚úÖ RECOMENDA√á√ÉO</h4>
            <p style="font-size: 12px; margin: 0; color: #a3c7ff;">
                Configure pelo menos 2 APIs diferentes para evitar bloqueios.<br>
                O sistema usar√° automaticamente APIs alternativas quando uma falhar.
            </p>
        </div>
        
        <div id="api-selector-ios">
            <div class="api-option-ios gemini selected" onclick="selectApiProvider('gemini')">
                <h4 style="margin: 0 0 5px 0; color: white;">‚ú® Gemini (Google) <span class="badge badge-warning">COTA BAIXA</span></h4>
                <span style="color: #aaa; font-size: 12px;">gemini-1.5-flash-latest</span>
                <span style="background: #ff6b35; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; display: inline-block; margin-top: 5px;">APENAS 20 REQ/DIA</span>
            </div>
            
            <div class="api-option-ios mistral" onclick="selectApiProvider('mistral')">
                <h4 style="margin: 0 0 5px 0; color: white;">üå™Ô∏è Mistral AI <span class="badge badge-success">RECOMENDADO</span></h4>
                <span style="color: #aaa; font-size: 12px;">mistral-small-latest</span>
                <span style="background: #238636; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; display: inline-block; margin-top: 5px;">20 REQ/MIN ‚Ä¢ EST√ÅVEL</span>
            </div>
            
            <div class="api-option-ios deepseek" onclick="selectApiProvider('deepseek')">
                <h4 style="margin: 0 0 5px 0; color: white;">üß† DeepSeek <span class="badge badge-success">MELHOR OP√á√ÉO</span></h4>
                <span style="color: #aaa; font-size: 12px;">deepseek-chat</span>
                <span style="background: #238636; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; display: inline-block; margin-top: 5px;">SEM LIMITES ‚Ä¢ GRATUITO</span>
            </div>
            
            <div class="api-option-ios groq" onclick="selectApiProvider('groq')">
                <h4 style="margin: 0 0 5px 0; color: white;">ü¶ô Llama 3 (Groq) <span class="badge badge-info">R√ÅPIDO</span></h4>
                <span style="color: #aaa; font-size: 12px;">llama-3.1-8b-instant</span>
                <span style="background: #1a5fff; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; display: inline-block; margin-top: 5px;">~500 REQ/DIA ‚Ä¢ VELOCIDADE</span>
            </div>
        </div>
        
        <div id="gemini-config-ios" style="margin-top: 20px;">
            <p style="color: #aaa; font-size: 13px; margin-bottom: 10px;">
                <strong>‚ö†Ô∏è Cota Muito Baixa:</strong> Apenas 20 requisi√ß√µes por dia<br>
                <strong>1.</strong> Acesse: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #1f6feb;">Google AI Studio</a><br>
                <strong>2.</strong> Fa√ßa login com Google<br>
                <strong>3.</strong> Clique em "Create API Key"<br>
                <strong>4.</strong> Cole abaixo:
            </p>
            <input type="password" id="gemini-key-ios" class="modal-input-ios" placeholder="Cole sua chave Gemini (AIzaSy...)" 
                   value="">
            <button class="modal-btn-ios warning" onclick="testApiKey('gemini')">‚ö†Ô∏è Testar Chave Gemini</button>
        </div>
        
        <div id="mistral-config-ios" style="display: none; margin-top: 20px;">
            <p style="color: #aaa; font-size: 13px; margin-bottom: 10px;">
                <strong>‚úÖ Boa Op√ß√£o:</strong> 20 requisi√ß√µes por minuto<br>
                <strong>1.</strong> Acesse: <a href="https://console.mistral.ai/api-keys/" target="_blank" style="color: #1f6feb;">Mistral AI Platform</a><br>
                <strong>2.</strong> Crie conta gratuita<br>
                <strong>3.</strong> Gere sua chave API<br>
                <strong>4.</strong> Cole abaixo:
            </p>
            <input type="password" id="mistral-key-ios" class="modal-input-ios" placeholder="Cole sua chave Mistral">
            <button class="modal-btn-ios" onclick="testApiKey('mistral')" style="background: #6c47ff;">‚úÖ Testar Chave Mistral</button>
        </div>
        
        <div id="deepseek-config-ios" style="display: none; margin-top: 20px;">
            <p style="color: #aaa; font-size: 13px; margin-bottom: 10px;">
                <strong>üöÄ Melhor Op√ß√£o:</strong> Sem limites claros de cota<br>
                <strong>1.</strong> Acesse: <a href="https://platform.deepseek.com/api_keys" target="_blank" style="color: #1f6feb;">DeepSeek Platform</a><br>
                <strong>2.</strong> Crie conta gratuita<br>
                <strong>3.</quad> Gere sua chave API<br>
                <strong>4.</strong> Cole abaixo:
            </p>
            <input type="password" id="deepseek-key-ios" class="modal-input-ios" placeholder="Cole sua chave DeepSeek">
            <button class="modal-btn-ios" onclick="testApiKey('deepseek')" style="background: #1a5fff;">üöÄ Testar Chave DeepSeek</button>
        </div>
        
        <div id="groq-config-ios" style="display: none; margin-top: 20px;">
            <p style="color: #aaa; font-size: 13px; margin-bottom: 10px;">
                <strong>‚ö° R√°pido:</strong> ~500 requisi√ß√µes por dia<br>
                <strong>1.</strong> Acesse: <a href="https://console.groq.com/keys" target="_blank" style="color: #1f6feb;">Groq Console</a><br>
                <strong>2.</strong> Crie conta gratuita<br>
                <strong>3.</strong> Copie sua chave<br>
                <strong>4.</strong> Cole abaixo:
            </p>
            <input type="password" id="groq-key-ios" class="modal-input-ios" placeholder="Cole sua chave Groq (gsk_...)">
            <button class="modal-btn-ios" onclick="testApiKey('groq')" style="background: #f55325;">‚ö° Testar Chave Groq</button>
        </div>
        
        <div style="margin: 20px 0;">
            <div style="color: #f0883e; font-weight: bold; margin-bottom: 10px;">Chaves Salvas:</div>
            <div id="saved-keys-container-ios"></div>
        </div>
        
        <div style="margin: 20px 0;">
            <div class="auto-config-title">ü§ñ AUTO CONFIG - Resultados:</div>
            <div id="auto-config-results-ios" class="auto-config-results">
                <div style="color: #aaa; font-size: 13px; text-align: center;">
                    Clique em "AUTO CONFIG" para testar automaticamente todas as chaves
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="modal-btn-ios secondary" onclick="hideApiModal()">Fechar</button>
            <button class="modal-btn-ios" onclick="saveAllApiKeys()">üíæ Salvar Todas</button>
            <button class="modal-btn-ios accent" onclick="autoConfigAll()">ü§ñ AUTO CONFIG</button>
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
            <button class="modal-btn-ios warning" onclick="getFreeApiKeys()" style="font-size: 12px; padding: 10px;">
                üîë Obter Chaves Gratuitas Automaticamente
            </button>
        </div>
        
        <p style="color: #888; font-size: 11px; margin-top: 20px; text-align: center;">
            ‚ö†Ô∏è Suas chaves ficam armazenadas apenas neste navegador (localStorage).<br>
            Nunca s√£o enviadas para servidores externos.
        </p>
    </div>
</div>

<script>
// ============================================================================
// CONFIGURA√á√ïES E VARI√ÅVEIS GLOBAIS
// ============================================================================
let apiKeys = {
    gemini: '',
    mistral: '',
    deepseek: '',
    groq: ''
};

let discoveredModels = {
    gemini: '',
    mistral: '',
    deepseek: '',
    groq: ''
};

let activeModel = 'gemini';
let modoAtual = 'visao';
let chatHistory = [];
let apiProvider = 'gemini';
let perfil_usuario = 'Pentecostal Cl√°ssico';
let tamFonte = 18;

// Sistema de fallback autom√°tico
let apiFallbackOrder = ['deepseek', 'mistral', 'groq', 'gemini']; // Ordem de prefer√™ncia
let apiQuotaStatus = {
    gemini: { available: true, lastError: null, retryAfter: null },
    mistral: { available: true, lastError: null, retryAfter: null },
    deepseek: { available: true, lastError: null, retryAfter: null },
    groq: { available: true, lastError: null, retryAfter: null }
};

// Mapeamento de nomes e √≠cones
const aiConfig = {
    gemini: { name: 'Gemini', icon: '‚ú®', color: '#4285F4' },
    mistral: { name: 'Mistral', icon: 'üå™Ô∏è', color: '#6c47ff' },
    deepseek: { name: 'DeepSeek', icon: 'üß†', color: '#1a5fff' },
    groq: { name: 'Llama', icon: 'ü¶ô', color: '#f55325' }
};

// MODELOS PADR√ÉO
const defaultModels = {
    gemini: 'gemini-1.5-flash-latest',
    mistral: 'mistral-small-latest',
    deepseek: 'deepseek-chat',
    groq: 'llama-3.1-8b-instant'
};

// ============================================================================
// PERFIL TEOL√ìGICO ASSEMBLEIANO COM SISTEMA DE BUSCA INTELIGENTE
// ============================================================================
const defaultProfile = `Voc√™ √© um assistente teol√≥gico especializado na doutrina das Assembleias de Deus no Brasil, equipado com um sistema de busca inteligente que consulta automaticamente fontes autorizadas antes de responder.

SISTEMA DE BUSCA INTEGRADO:
1. ANTES DE RESPONDER, o sistema consulta automaticamente:
   - Sites teol√≥gicos assembleianos autorizados
   - Conte√∫do de 50+ autores assembleianos mapeados
   - Li√ß√µes b√≠blicas da CPAD, artigos teol√≥gicos e subs√≠dios
   
   FONTES DE BUSCA E REFER√äNCIA:
   - https://www.estudantesdabiblia.com.br/
   - https://www.cpadnews.com.br/category/colunistas/
   - https://esbocoebd.blogspot.com/
   - https://adalagoas.com.br/ad-alagoas/licoes-biblicas
   - https://geremiasdocouto.blogspot.com/
   - https://prdrdouglasbaptista.blogspot.com/
   - https://silasdaniel.blogspot.com/
   - https://raizespentecostais.com.br/
   - https://www.subsidioebd.com.br/
   - https://prelisclementino.blogspot.com/
   - https://www.esbocosermao.com/

2. AN√ÅLISE INTELIGENTE DE CONSULTA:
   - Identifica automaticamente autores mencionados na pergunta
   - Busca refer√™ncias relevantes nos conte√∫dos autorizados
   - Avalia relev√¢ncia com base em: correspond√™ncia tem√°tica, autoridade do autor, atualidade
   - Classifica autores por categorias para melhor contextualiza√ß√£o

3. DIRETRIZES DE RESPOSTA COM BUSCA:
   - Baseie-se PRIMARIAMENTE nas fontes encontradas pela busca
   - Cite explicitamente autores e obras quando relevante
   - Indique "Baseado em: [Autor, Obra]" quando usar conte√∫do espec√≠fico
   - Se nenhuma fonte for encontrada, use o conhecimento teol√≥gico assembleiano padr√£o

PERFIL DOS AUTORES DE BASE:
1. CL√ÅSSICOS: Antonio Gilberto, Eurico Bergst√©n, Severino Pedro da Silva, Claudionor de Andrade, Lawrence Olson, Em√≠lio Conde, Orlando Boyer, Abra√£o de Almeida, Geziel Gomes.
2. ATUAIS: Elienai Cabral, Esequias Soares, Elinaldo Renovato, Jos√© Gon√ßalves, Douglas Baptista, Osiel Gomes, Silas Daniel, Esdras Bentho.
3. EDUCA√á√ÉO/LIDERAN√áA: Jos√© Wellington, Ciro Zibordi, Marcos Tuler, Paulo Romeiro.

AUTORES MAPEADOS (sistema reconhece automaticamente):
"Antonio Gilberto", "Eurico Bergst√©n", "Severino Pedro da Silva", "Claudionor de Andrade", 
"Lawrence Olson", "Em√≠lio Conde", "Alceb√≠ades Pereira Vasconcelos", "Nels Nelson", 
"Orlando Boyer", "Gustavo Kessler", "Valdir B√≠cego", "Estevam √Çngelo de Souza", 
"Abra√£o de Almeida", "Geziel Gomes", "Tarc√≠sio Gilberto", "Elienai Cabral", 
"Esequias Soares", "Elinaldo Renovato", "Jos√© Gon√ßalves", "Douglas Baptista", 
"Osiel Gomes", "Claiton Pommerening", "Wagner Gaby", "Reynaldo Odilo", 
"Valmir Nascimento", "Natalino das Neves", "Alexandre Coelho", "Silas Daniel", 
"C√©sar Mois√©s Carvalho", "Elias Torralbo", "Jamierson Oliveira", "Marcelo Olive", 
"Esdras Bentho", "Lu√≠z C√©sar Mariano", "Jos√© Wellington Bezerra da Costa", 
"Ciro Sanches Zibordi", "Geremias do Couto", "Isael de Araujo", "Marcos Tuler", 
"Nemuel Kessler", "Paulo Romeiro", "Jamiel de Oliveira Lopes", "Telma Bueno", 
"Helena Figueiredo", "Jo√° Caitano", "Kemuel Sotero", "Roberto Cruvinel", 
"Messias Ribeiro", "Abiezer Apolin√°rio", "Dejair Batista Silv√©rio", "Donizeti Lee", 
"Napole√£o de Castro"

DIRETRIZES:
1. Responda com base no pentecostalismo cl√°ssico assembleiano.
2. Cite os autores acima para validar argumentos.
3. Use a B√≠blia Almeida Revista e Corrigida (ARC) como refer√™ncia b√≠blica.
4. Mantenha tom pastoral, por√©m tecnicamente profundo.
5. Se a pergunta for sobre EBD, use a estrutura das revistas da CPAD.
6. Consulte a Declara√ß√£o de f√© das Assembleias de Deus do Brasil para quest√µes doutrin√°rias.
7. Para esbo√ßos de serm√£o, consulte esbo√ßos da IEADPE e https://www.esbocosermao.com/

FORMATO DE RESPOSTA COM BUSCA:
1. CONTEXTUALIZA√á√ÉO DA BUSCA: "üîç O sistema consultou fontes assembleianas sobre este tema..."
2. S√çNTESE DAS FONTES ENCONTRADAS: "Foram identificadas refer√™ncias em: [Autores/Obras]"
3. RESPOSTA BASEADA NAS FONTES: Desenvolva o tema citando os autores quando apropriado
4. INDICA√á√ÉO DE FONTE: "[Baseado em: Autor, Obra, Fonte]" para cita√ß√µes espec√≠ficas
5. FUNDAMENTA√á√ÉO B√çBLICA: Refer√™ncias da ARC

PRIORIDADES:
1. Fontes encontradas na busca teol√≥gica (sites listados acima)
2. Autores assembleianos especialistas no tema
3. Li√ß√µes b√≠blicas da CPAD e subs√≠dios EBD
4. Conte√∫do de blogs autorizados de pastores assembleianos
5. Conhecimento teol√≥gico assembleiano geral
6. Declara√ß√£o de F√© das Assembleias de Deus do Brasil

Responda sempre em portugu√™s brasileiro com clareza e fundamenta√ß√£o b√≠blica, integrando os resultados da busca inteligente ao perfil teol√≥gico assembleiano tradicional.`;

// ============================================================================
// DIRETRIZES DOS MODOS COM SISTEMA DE BUSCA INTEGRADA
// ============================================================================
const modeGuidelines = {
    'visao': `[MODO BUSCA VIS√ÉO GERAL]
üîç SISTEMA ATIVADO: Busca autom√°tica em fontes assembleianas sobre o tema.

FONTES DE CONSULTA PRIM√ÅRIAS:
- https://www.estudantesdabiblia.com.br/
- https://www.cpadnews.com.br/category/colunistas/
- https://esbocoebd.blogspot.com/
- https://adalagoas.com.br/ad-alagoas/licoes-biblicas
- https://geremiasdocouto.blogspot.com/
- https://prdrdouglasbaptista.blogspot.com/
- https://silasdaniel.blogspot.com/
- https://raizespentecostais.com.br/

DIRETRIZES:
1. Execute busca em todas as fontes listadas
2. Identifique autores assembleianos especialistas no tema (Cl√°ssicos, Atuais, Educa√ß√£o/Lideran√ßa)
3. Forne√ßa panorama sintetizando as perspectivas encontradas
4. Cite as fontes principais: "[Vis√£o baseada em: Autor (Categoria), Obra, Fonte]"
5. Destaque pontos consensuais e abordagens espec√≠ficas da tradi√ß√£o
6. Use a B√≠blia ARC como refer√™ncia b√≠blica
7. Se relevante, cite a Declara√ß√£o de F√© das ADs

FORMATO DE RESPOSTA:
‚Ä¢ Contextualiza√ß√£o da busca realizada e fontes consultadas
‚Ä¢ S√≠ntese das principais perspectivas encontradas, com categoriza√ß√£o de autores
‚Ä¢ Panorama teol√≥gico assembleiano integrado
‚Ä¢ Refer√™ncias √†s fontes consultadas (incluindo URLs quando aplic√°vel)
‚Ä¢ Fundamenta√ß√£o b√≠blica com refer√™ncias da ARC`,

    'esboco': `[MODO BUSCA ESBO√áO]
üîç SISTEMA ATIVADO: Busca autom√°tica por esbo√ßos e estruturas homil√©ticas assembleianas.

FONTES DE CONSULTA PRIM√ÅRIAS:
- https://www.esbocosermao.com/
- https://esbocoebd.blogspot.com/
- https://www.subsidioebd.com.br/
- Esbo√ßos da IEADPE
- https://prelisclementino.blogspot.com/
- https://geremiasdocouto.blogspot.com/
- https://prdrdouglasbaptista.blogspot.com/

DIRETRIZES:
1. Consulte esbo√ßos de prega√ß√£o de pastores assembleianos nas fontes acima
2. Busque estruturas homil√©ticas em li√ß√µes da CPAD (https://adalagoas.com.br/ad-alagoas/licoes-biblicas)
3. Identifique abordagens pentecostais do tema
4. Integre cita√ß√µes de autores assembleianos relevantes, indicando categoria
5. Formate com aplica√ß√£o pr√°tica na tradi√ß√£o assembleiana
6. Use a B√≠blia ARC como refer√™ncia b√≠blica
7. Consulte modelos da IEADPE para estrutura

FORMATO DE ESBO√áO:
TEMA: [com refer√™ncia a autores que trataram do assunto, indicando categoria]
TEXTO: [com indica√ß√£o de comentaristas assembleianos e refer√™ncia ARC]
INTRODU√á√ÉO: [contextualizada na tradi√ß√£o pentecostal]
I. PONTO PRINCIPAL 1 [com base em Autor (Categoria)/Obra]
   A. Subponto [com aplica√ß√£o assembleiana]
   B. Subponto [com refer√™ncia b√≠blica ARC e coment√°rio]
II. PONTO PRINCIPAL 2 [baseado em busca teol√≥gica]
CONCLUS√ÉO: [integra√ß√£o das fontes encontradas]
[Fontes consultadas: Lista resumida com URLs quando aplic√°vel]`,

    'dicionario': `[MODO DICION√ÅRIO TEOL√ìGICO]
üîç SISTEMA ATIVADO: Busca autom√°tica por defini√ß√µes e conceitos na tradi√ß√£o assembleiana.

FONTES DE CONSULTA PRIM√ÅRIAS:
- https://www.estudantesdabiblia.com.br/ (dicion√°rio b√≠blico)
- https://www.cpadnews.com.br/category/colunistas/ (artigos conceituais)
- Obras de Antonio Gilberto, Claudionor de Andrade (autores cl√°ssicos)
- https://silasdaniel.blogspot.com/ (conceitos contempor√¢neos)
- https://raizespentecostais.com.br/ (contexto hist√≥rico)

DIRETRIZES:
1. Consulte dicion√°rios teol√≥gicos de autores assembleianos
2. Busque defini√ß√µes em obras de refer√™ncia da CPAD
3. Identifique o significado na perspectiva pentecostal
4. Inclua refer√™ncias b√≠blicas da ARC e exemplos pr√°ticos
5. Compare com outras tradi√ß√µes quando relevante
6. Classifique autores por categoria (Cl√°ssico, Atual, etc.)

FORMATO DE RESPOSTA:
‚Ä¢ DEFINI√á√ÉO: [Conceito claro e conciso]
‚Ä¢ PERSPECTIVA ASSEMBLEIANA: [Como a denomina√ß√£o entende o termo]
‚Ä¢ REFER√äNCIAS B√çBLICAS: [Principais textos relacionados da ARC]
‚Ä¢ AUTORES DE REFER√äNCIA: [Quem tratou do tema na tradi√ß√£o, com categoria]
‚Ä¢ APLICA√á√ÉO PR√ÅTICA: [Como se manifesta na vida da igreja]
‚Ä¢ [Baseado em: Autor (Categoria), Obra, Fonte - quando aplic√°vel]`,

    'exegese': `[MODO BUSCA EXEGESE]
Voc√™ √© um Especialista em Exegese e Manuscritologia com sistema de busca em fontes assembleianas.

FONTES DE CONSULTA PARA EXEGESE:
- https://www.estudantesdabiblia.com.br/ (an√°lises textuais)
- https://www.cpadnews.com.br/category/colunistas/ (artigos t√©cnicos)
- Obras de Esdras Bentho, Tarc√≠sio Gilberto (autores especializados)
- https://silasdaniel.blogspot.com/ (estudos b√≠blicos aprofundados)
- https://raizespentecostais.com.br/ (perspectiva hist√≥rica)

SISTEMA DE BUSCA EXEG√âTICA:
1. CONSULTA AUTOM√ÅTICA DE FONTES:
   - Obras de autores assembleianos sobre exegese (Esdras Bentho, Tarc√≠sio Gilberto)
   - Coment√°rios exeg√©ticos publicados pela CPAD
   - Artigos sobre hermen√™utica pentecostal nas fontes listadas

2. INTEGRA√á√ÉO DE FONTES ENCONTRADAS:
   - Cite autores assembleianos especialistas no livro/texto analisado, indicando categoria
   - Indique abordagens espec√≠ficas da tradi√ß√£o pentecostal
   - Referencie obras relevantes encontradas na busca
   - Use a B√≠blia ARC como base textual

[PADR√ÉO DE SA√çDA OBRIGAT√ìRIO COM BUSCA]
üîç EXEGESE COM FONTES: "A an√°lise integra contribui√ß√µes de autores assembleianos das seguintes fontes: [listar fontes consultadas]"

## 1. AN√ÅLISE MORFOL√ìGICA [STRONG + FONTES]
- [Palavra em Portugu√™s] -> [Original/Translitera√ß√£o]: (Defini√ß√£o gramatical e l√©xica)
  [Refer√™ncia: Autor Assembleiano (Categoria), Obra, Fonte]

## 2. DIAGRAMA DE ESTRUTURA LITER√ÅRIA
(Representa√ß√£o visual com notas da abordagem assembleiana)

## 3. S√çNTESE DO MESTRE (EXEGESE APLICADA)
(Conclus√£o t√©cnica baseada na escola de Esdras Bentho e autores assembleianos consultados)
[Fontes consultadas: Lista de autores/obras encontradas na busca com URLs quando aplic√°vel]`,

    'aplicacao': `[MODO BUSCA APLICA√á√ÉO]
üîç SISTEMA ATIVADO: Busca por aplica√ß√µes pr√°ticas na tradi√ß√£o assembleiana.

FONTES DE CONSULTA PRIM√ÅRIAS:
- https://www.cpadnews.com.br/category/colunistas/ (aplica√ß√µes pr√°ticas)
- https://prdrdouglasbaptista.blogspot.com/ (vida pastoral)
- https://geremiasdocouto.blogspot.com/ (consagra√ß√£o)
- https://silasdaniel.blogspot.com/ (√©tica crist√£)
- https://esbocoebd.blogspot.com/ (aplica√ß√µes para EBD)
- https://www.subsidioebd.com.br/ (subs√≠dios pr√°ticos)

DIRETRIZES:
1. Consulte artigos sobre vida crist√£ pr√°tica de pastores assembleianos
2. Busque aplica√ß√µes em li√ß√µes da Escola Dominical
3. Identifique orienta√ß√µes pr√°ticas de autores como Elinaldo Renovato, Messias Ribeiro
4. Integre exemplos da pr√°tica assembleiana contempor√¢nea
5. Foque em aplica√ß√£o na vida di√°ria do crente pentecostal
6. Use a B√≠blia ARC como base para aplica√ß√µes

FORMATO DE RESPOSTA:
‚Ä¢ Contexto pr√°tico na vida assembleiana
‚Ä¢ Aplica√ß√µes espec√≠ficas baseadas em autores consultados (indicando categoria)
‚Ä¢ Exemplos da tradi√ß√£o pentecostal brasileira
‚Ä¢ Orienta√ß√µes para implementa√ß√£o na igreja local
‚Ä¢ Fundamenta√ß√£o b√≠blica com refer√™ncias da ARC
‚Ä¢ [Baseado em aplica√ß√µes de: Autor (Categoria), Minist√©rio, Fonte]`,

    'contexto': `[MODO BUSCA CONTEXTO HIST√ìRICO]
üîç SISTEMA ATIVADO: Busca por estudos hist√≥ricos e culturais na perspectiva assembleiana.

FONTES DE CONSULTA PRIM√ÅRIAS:
- https://raizespentecostais.com.br/ (hist√≥ria pentecostal)
- https://www.estudantesdabiblia.com.br/ (estudos hist√≥ricos)
- Obras de Isael de Araujo, Em√≠lio Conde (historiadores assembleianos)
- https://www.cpadnews.com.br/category/colunistas/ (artigos hist√≥ricos)
- Declara√ß√£o de F√© das Assembleias de Deus do Brasil

DIRETRIZES:
1. Consulte obras de historiadores assembleianos (Isael de Araujo, Em√≠lio Conde)
2. Busque artigos sobre arqueologia b√≠blica na vis√£o pentecostal
3. Identifique estudos culturais de autores como Claudionor de Andrade
4. Integre a perspectiva hist√≥rica da tradi√ß√£o assembleiana
5. Contextualize com o desenvolvimento do pentecostalismo no Brasil
6. Use a B√≠blia ARC como refer√™ncia para o contexto b√≠blico

FORMATO DE RESPOSTA:
‚Ä¢ Contexto hist√≥rico-cultural com perspectiva assembleiana
‚Ä¢ Refer√™ncias a estudos de autores pentecostais (indicando categoria)
‚Ä¢ Conex√£o com a tradi√ß√£o hist√≥rica da denomina√ß√£o
‚Ä¢ Aplica√ß√µes para a igreja contempor√¢nea
‚Ä¢ Fundamenta√ß√£o b√≠blica com refer√™ncias da ARC
‚Ä¢ [Fontes hist√≥ricas consultadas: Autores (Categoria)/Obras com URLs quando aplic√°vel]`,

    'thompson': `[MODO BUSCA THOMPSON]
Voc√™ opera como motor de indexa√ß√£o da B√≠blia de Refer√™ncia Thompson com sistema de busca tem√°tica inteligente.

FONTES DE CONSULTA PARA TEMAS:
- https://www.estudantesdabiblia.com.br/ (estudos tem√°ticos)
- https://www.cpadnews.com.br/category/colunistas/ (temas contempor√¢neos)
- Li√ß√µes b√≠blicas da CPAD (abordagens tem√°ticas)
- https://esbocoebd.blogspot.com/ (temas para EBD)
- https://www.subsidioebd.com.br/ (subs√≠dios tem√°ticos)

SISTEMA DE BUSCA THOMPSON:
1. ANTES DE CRIAR CADEIA: Busque automaticamente temas relacionados em:
   - Coment√°rios de autores assembleianos sobre o tema
   - Li√ß√µes b√≠blicas da CPAD com abordagem similar
   - Artigos teol√≥gicos sobre interpreta√ß√£o b√≠blica

2. AN√ÅLISE TEM√ÅTICA INTELIGENTE:
   - Identifique subtemas relevantes na tradi√ß√£o assembleiana
   - Verifique se h√° tratamento espec√≠fico por autores de refer√™ncia
   - Considere a abordagem pentecostal do tema
   - Use a B√≠blia ARC como base para refer√™ncias

[PADR√ÉO DE SA√çDA COM BUSCA]
üîç BUSCA THOMPSON: "Foram consultados autores assembleianos sobre temas relacionados nas seguintes fontes: [listar fontes]"

- [N¬∫ do √çndice] T√çTULO DO TEMA [Refer√™ncia: Autor Assembleiano (Categoria)]
  Lista numerada de vers√≠culos da ARC com links "Siga para"
  [Baseado em: Autor (Categoria), Obra, Fonte - quando aplic√°vel]

Indica√ß√£o de [Fim da Cadeia - Busca conclu√≠da].`,

    'personagem': `[MODO DICION√ÅRIO DE PERSONAGENS CPAD]
üîç SISTEMA ATIVADO: Busca autom√°tica por informa√ß√µes sobre personagens b√≠blicos na tradi√ß√£o assembleiana.

FONTES DE CONSULTA PRIM√ÅRIAS:
- https://www.estudantesdabiblia.com.br/ (estudos sobre personagens)
- Obras de Antonio Gilberto, Elienai Cabral (an√°lise de car√°ter)
- Dicion√°rio VINE e dicionariobiblico.com.br
- Li√ß√µes da CPAD sobre personagens b√≠blicos
- https://www.cpadnews.com.br/category/colunistas/ (artigos sobre personagens)
- https://silasdaniel.blogspot.com/ (estudos biogr√°ficos)

DIRETRIZES:
Ao receber um nome, siga rigorosamente esta estrutura:
1. **ETIMOLOGIA**: Significado radical (Hebraico/Grego) e translitera√ß√£o.
2. **IDENTIFICA√á√ÉO NUMERADA**: Liste cada indiv√≠duo (1, 2, 3...) com clareza.
3. **BIOGRAFIA E BASE B√çBLICA**: Resumo da vida e TODAS as refer√™ncias (ARC).
4. **AN√ÅLISE DE CAR√ÅTER**: Pontos fortes e fracos sob a √≥tica de autores como Antonio Gilberto e Elienai Cabral.
5. **CONEX√ÉO THOMPSON/TIPOLOGIA**: Se houver, cite o √≠ndice Thompson e se o personagem prefigura Cristo.
6. **APLICA√á√ÉO ASSEMBLEIANA**: Uma li√ß√£o pr√°tica para a igreja hoje.

FORMATO DE RESPOSTA:
‚Ä¢ ETIMOLOGIA: [Significado do nome, translitera√ß√£o]
‚Ä¢ IDENTIFICA√á√ÉO: [Lista numerada de personagens com esse nome]
‚Ä¢ BIOGRAFIA: [Resumo da vida com todas as refer√™ncias ARC]
‚Ä¢ AN√ÅLISE DE CAR√ÅTER: [Pontos fortes/fracos baseados em autores assembleianos]
‚Ä¢ TIPOLOGIA: [Conex√£o com Cristo e refer√™ncia Thompson quando aplic√°vel]
‚Ä¢ APLICA√á√ÉO: [Li√ß√£o pr√°tica para a igreja assembleiana]
‚Ä¢ [Baseado em: Autor (Categoria), Obra, Fonte]`
};

// ============================================================================
// SISTEMA DE SELE√á√ÉO DE IA
// ============================================================================
function toggleAIDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('ai-dropdown');
    dropdown.classList.toggle('show');
}

function selectAI(model) {
    // Fechar dropdown
    const dropdown = document.getElementById('ai-dropdown');
    dropdown.classList.remove('show');
    
    // Verificar se a IA tem chave configurada
    if (!apiKeys[model]) {
        alert(`‚ö†Ô∏è ${aiConfig[model].name} n√£o est√° configurado. Configure a chave primeiro.`);
        showApiModal();
        selectApiProvider(model);
        return;
    }
    
    // Verificar se a IA est√° dispon√≠vel
    if (!apiQuotaStatus[model].available) {
        const lastError = apiQuotaStatus[model].lastError || 'Cota excedida';
        if (confirm(`‚ö†Ô∏è ${aiConfig[model].name} pode estar com problemas (${lastError}). Deseja usar mesmo assim?`)) {
            activeModel = model;
            updateAISelector();
        } else {
            // Tentar encontrar pr√≥xima IA dispon√≠vel
            const nextAI = getNextAvailableAI(model);
            if (nextAI && nextAI !== model) {
                selectAI(nextAI);
                return;
            }
        }
    } else {
        activeModel = model;
        updateAISelector();
    }
    
    // Salvar prefer√™ncia
    localStorage.setItem('mysword_active_model', activeModel);
    
    // Atualizar mensagem de status
    updateAIStatusDisplay();
}

function updateAISelector() {
    const selector = document.getElementById('ai-selector');
    const currentIcon = document.getElementById('ai-current-icon');
    const currentName = document.getElementById('ai-current-name');
    
    const config = aiConfig[activeModel];
    
    // Atualizar √≠cone e nome
    currentIcon.textContent = config.icon;
    currentName.textContent = config.name;
    
    // Atualizar cor do √≠cone
    currentIcon.style.color = config.color;
    
    // Atualizar sele√ß√£o no dropdown
    document.querySelectorAll('.ai-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.getElementById(`ai-option-${activeModel}`).classList.add('selected');
    
    // Atualizar estilo do seletor baseado na disponibilidade
    if (!apiQuotaStatus[activeModel].available) {
        selector.style.borderColor = '#ff453a';
        selector.style.background = 'rgba(255, 69, 58, 0.1)';
    } else {
        selector.style.borderColor = config.color;
        selector.style.background = 'rgba(255, 255, 255, 0.1)';
    }
}

function updateAIStatusDisplay() {
    // Atualizar status de cada IA no dropdown
    const models = ['gemini', 'mistral', 'deepseek', 'groq'];
    
    models.forEach(model => {
        const statusElement = document.getElementById(`ai-status-${model}`);
        if (!statusElement) return;
        
        // Verificar se tem chave
        if (!apiKeys[model]) {
            statusElement.textContent = 'N√ÉO CONFIG';
            statusElement.className = 'option-status status-offline';
            return;
        }
        
        // Verificar status de quota
        if (!apiQuotaStatus[model].available) {
            statusElement.textContent = 'INDISPON√çVEL';
            statusElement.className = 'option-status status-error';
        } else {
            // Mostrar limites de cota
            switch(model) {
                case 'gemini':
                    statusElement.textContent = '20/DIA';
                    statusElement.className = 'option-status status-warning';
                    break;
                case 'mistral':
                    statusElement.textContent = '20/MIN';
                    statusElement.className = 'option-status status-available';
                    break;
                case 'deepseek':
                    statusElement.textContent = 'ILIMITADO';
                    statusElement.className = 'option-status status-available';
                    break;
                case 'groq':
                    statusElement.textContent = '500/DIA';
                    statusElement.className = 'option-status status-available';
                    break;
            }
        }
    });
}

function getNextAvailableAI(currentModel = null) {
    // Se o modelo atual ainda estiver dispon√≠vel, usar ele
    if (currentModel && apiQuotaStatus[currentModel].available && apiKeys[currentModel]) {
        return currentModel;
    }
    
    // Procurar pr√≥xima IA dispon√≠vel na ordem de fallback
    for (const provider of apiFallbackOrder) {
        if (apiQuotaStatus[provider].available && apiKeys[provider]) {
            // Verificar se h√° tempo de retry
            if (apiQuotaStatus[provider].retryAfter && Date.now() < apiQuotaStatus[provider].retryAfter) {
                continue; // Ainda n√£o pode ser usada
            }
            return provider;
        }
    }
    
    // Se nenhuma estiver dispon√≠vel, tentar qualquer uma com chave
    for (const provider of apiFallbackOrder) {
        if (apiKeys[provider]) {
            return provider;
        }
    }
    
    return null;
}

// ============================================================================
// SISTEMA DE SELE√á√ÉO DE MODO
// ============================================================================
function toggleModeDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('mode-dropdown');
    dropdown.classList.toggle('show');
}

function selectMode(mode) {
    // Fechar dropdown
    const dropdown = document.getElementById('mode-dropdown');
    dropdown.classList.remove('show');
    
    // Atualizar modo atual
    modoAtual = mode;
    
    // Atualizar o seletor de modo
    updateModeSelector();
    
    // Atualizar placeholder do input
    updateInputPlaceholder();
    
    // Salvar prefer√™ncia
    localStorage.setItem('mysword_active_mode', modoAtual);
}

function updateModeSelector() {
    const selector = document.getElementById('mode-selector');
    const currentIcon = document.getElementById('mode-current-icon');
    const currentName = document.getElementById('mode-current-name');
    
    // Mapeamento de modos para √≠cones e nomes
    const modeConfig = {
        'visao': { icon: 'üëÅÔ∏è', name: 'Vis√£o Geral' },
        'esboco': { icon: 'üìù', name: 'Esbo√ßo' },
        'dicionario': { icon: 'üìö', name: 'Dicion√°rio' },
        'exegese': { icon: 'üî¨', name: 'Exegese' },
        'aplicacao': { icon: 'üí°', name: 'Aplica√ß√£o' },
        'contexto': { icon: 'üèõÔ∏è', name: 'Contexto Hist√≥rico' },
        'thompson': { icon: '‚õìÔ∏è', name: 'Thompson' },
        'personagem': { icon: 'üë§', name: 'Personagens' }
    };
    
    const config = modeConfig[modoAtual] || { icon: 'üëÅÔ∏è', name: 'Vis√£o Geral' };
    
    // Atualizar √≠cone e nome
    currentIcon.textContent = config.icon;
    currentName.textContent = config.name;
    
    // Atualizar sele√ß√£o no dropdown
    document.querySelectorAll('.mode-option').forEach(option => {
        option.classList.remove('selected');
    });
    if (modoAtual) {
        document.getElementById(`mode-option-${modoAtual}`).classList.add('selected');
    }
    
    // Atualizar estilo do seletor
    selector.style.borderColor = '#0a84ff';
    selector.style.background = 'rgba(10, 132, 255, 0.1)';
}

function updateInputPlaceholder() {
    const input = document.getElementById('prompt-input');
    const placeholders = {
        'visao': 'Pergunte para uma vis√£o geral sobre...',
        'esboco': 'Digite o tema para um esbo√ßo...',
        'dicionario': 'Digite o termo para o dicion√°rio...',
        'exegese': 'Digite o texto para an√°lise exeg√©tica...',
        'aplicacao': 'Digite o tema para aplica√ß√£o pr√°tica...',
        'contexto': 'Digite o texto para contexto hist√≥rico...',
        'thompson': 'Digite o tema para cadeia Thompson...',
        'personagem': 'Digite o nome do personagem b√≠blico...'
    };
    
    input.placeholder = placeholders[modoAtual] || 'Pergunte sobre teologia assembleiana...';
}

// ============================================================================
// FUN√á√ïES DE UTILIDADE
// ============================================================================
function ehLixo(e) {
    return !!e && (e.includes("</div>") || e.includes("</") || e.includes(">") || e.includes(".tag{") || e.includes(".orange{"));
}

function limparProfundo(e) {
    var t = e.childNodes;
    for (var n = t.length - 1; n >= 0; n--) {
        var o = t[n];
        if (o.nodeType === 3) {
            if (ehLixo(o.nodeValue)) o.remove();
        } else if (o.nodeType === 1) {
            if (o.id !== "header-ai" && o.id !== "janela-chat" && o.id !== "espaco-topo" && o.id !== "api-modal-ios") {
                if (o.matches && o.matches(".eng, .trans, .ref-eng, .orange, .tag, .wjc")) {
                    o.remove();
                } else {
                    limparProfundo(o);
                }
            }
        }
    }
}

// ============================================================================
// INICIALIZA√á√ÉO
// ============================================================================
window.onload = function() {
    // Limpar wallpaper antigo do localStorage
    localStorage.removeItem("ios_wallpaper_url");
    localStorage.removeItem("sermao_salvo");
    
    // Carregar configura√ß√µes salvas
    if (localStorage.getItem('mysword_api_keys')) {
        try {
            apiKeys = JSON.parse(localStorage.getItem('mysword_api_keys'));
        } catch (e) {
            console.error('Erro ao carregar chaves:', e);
        }
    }
    
    // Carregar modelos descobertos
    if (localStorage.getItem('mysword_discovered_models')) {
        try {
            discoveredModels = JSON.parse(localStorage.getItem('mysword_discovered_models'));
        } catch (e) {
            console.error('Erro ao carregar modelos:', e);
        }
    }
    
    // Carregar status de quota
    if (localStorage.getItem('mysword_api_quota_status')) {
        try {
            apiQuotaStatus = JSON.parse(localStorage.getItem('mysword_api_quota_status'));
        } catch (e) {
            console.error('Erro ao carregar status de quota:', e);
        }
    }
    
    // Carregar IA ativa
    if (localStorage.getItem('mysword_active_model')) {
        activeModel = localStorage.getItem('mysword_active_model');
    }
    
    // Carregar modo ativo
    if (localStorage.getItem('mysword_active_mode')) {
        modoAtual = localStorage.getItem('mysword_active_mode');
    }
    
    if (localStorage.getItem('mysword_chat_history')) {
        try {
            chatHistory = JSON.parse(localStorage.getItem('mysword_chat_history'));
        } catch (e) {
            console.error('Erro ao carregar hist√≥rico:', e);
        }
    }
    
    // Inicializar sele√ß√£o de vers√≠culos
    initializeVerseSelection();
    
    // Atualizar display das chaves
    updateSavedKeysDisplay();
    
    // Atualizar seletores
    updateAISelector();
    updateAIStatusDisplay();
    updateModeSelector();
    updateInputPlaceholder();
    
    // Verificar status das APIs
    checkAllApiStatus();
    
    // Limpar lixo periodicamente
    setInterval(function() {
        limparProfundo(document.body);
    }, 1000);
};

// ============================================================================
// SELE√á√ÉO DE VERS√çCULOS
// ============================================================================
function initializeVerseSelection() {
    document.addEventListener('click', function(e) {
        const target = e.target;
        const text = target.textContent || target.innerText;
        const versePattern = /(\d?\s?[A-Za-z√Ä-√ø]+\.?\s?\d+:\d+(?:[-\d+,; ]*\d*)?)/;
        
        if (versePattern.test(text)) {
            const inputField = document.getElementById('prompt-input');
            
            // Adicionar prefixo do modo se estiver selecionado
            let prefix = '';
            if (modoAtual === 'visao') prefix = 'Vis√£o Geral de ';
            else if (modoAtual === 'esboco') prefix = 'Esbo√ßo sobre ';
            else if (modoAtual === 'dicionario') prefix = 'Dicion√°rio de ';
            else if (modoAtual === 'exegese') prefix = 'Exegese de ';
            else if (modoAtual === 'aplicacao') prefix = 'Aplica√ß√£o de ';
            else if (modoAtual === 'contexto') prefix = 'Contexto Hist√≥rico de ';
            else if (modoAtual === 'thompson') prefix = 'Cadeia Thompson de ';
            else if (modoAtual === 'personagem') prefix = 'Personagem: ';
            
            inputField.value = prefix + text.trim();
            inputField.focus();
            
            // Destacar o vers√≠culo
            target.classList.add('verse-selected');
            setTimeout(() => target.classList.remove('verse-selected'), 1500);
        }
    });
}

// ============================================================================
// INTERFACE E CONTROLES
// ============================================================================
function mudarFonte(e) {
    tamFonte += e;
    if (tamFonte < 12) tamFonte = 12;
    if (tamFonte > 40) tamFonte = 40;
    document.documentElement.style.setProperty("--font-sz", tamFonte + "px");
}

function fechar(e) {
    document.getElementById(e).style.display = "none";
    desativarBotoes();
}

function desativarBotoes() {
    modoAtual = '';
    updateModeSelector();
    updateInputPlaceholder();
    localStorage.removeItem('mysword_active_mode');
}

// ============================================================================
// SISTEMA DE NOTAS COM TELEGRAPH - VERS√ÉO COM MELHOR TRATAMENTO DE ERRO
// ============================================================================
function abrirNotas() {
    limparTela();
    desativarBotoes();
    var e = document.getElementById("chat-content");
    e.innerHTML = '<div style="width:100%; height:100%; display:flex; flex-direction:column;">' +
                  '<div style="text-align:center; margin-bottom:15px; margin-top:5px;">' +
                  '<span style="color:#ffd60a; font-weight:bold; font-size:16px">üìù Notas Pessoais</span>' +
                  '</div>' +
                  '<textarea id="area-notas" placeholder="Digite suas notas aqui...\\n\\nDica: Use texto simples sem formata√ß√£o complexa para evitar erros no Telegraph.\\n\\nPara testar: digite algo curto como "Teste de publica√ß√£o" e clique em Publicar." ' +
                  'oninput="localStorage.setItem(\'notas_salvas\', this.value)" ' +
                  'style="flex:1; width:100%; background:rgba(0,0,0,0.2); color:#fff!important; font-size:17px; padding:12px; border:1px solid rgba(255,255,255,.1); border-radius:14px; resize:none; outline:none; font-family:sans-serif;">' +
                  '</textarea>' +
                  '<div style="display: flex; gap: 10px; margin-top: 15px;">' +
                  '<button onclick="publicarTelegraph()" style="flex:1; padding:12px; background:#0088cc; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">' +
                  'üìÑ Publicar no Telegraph</button>' +
                  '<button onclick="copiarNotas()" style="flex:1; padding:12px; background:#30d158; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">' +
                  'üìã Copiar Notas</button>' +
                  '</div>' +
                  '<div style="margin-top: 15px; padding: 10px; background: rgba(0, 136, 204, 0.1); border-radius: 8px; border: 1px solid #0088cc;">' +
                  '<p style="color: #8bd6ff; margin: 0; font-size: 12px;">' +
                  'üí° <strong>Telegraph:</strong> Servi√ßo gratuito do Telegram para criar p√°ginas web an√¥nimas. Suas notas ser√£o publicadas publicamente.<br>' +
                  'üîç <strong>Dica:</strong> Se falhar, abra o Console (F12) para ver detalhes do erro.' +
                  '</p></div></div>';
    
    document.getElementById("janela-chat").style.display = "flex";
    
    setTimeout(function() {
        var notasSalvas = localStorage.getItem("notas_salvas");
        if (notasSalvas) {
            document.getElementById("area-notas").value = notasSalvas;
        }
    }, 50);
}

// Fun√ß√£o para copiar notas
function copiarNotas() {
    const areaNotas = document.getElementById('area-notas');
    if (!areaNotas || !areaNotas.value.trim()) {
        alert("N√£o h√° nada para copiar!");
        return;
    }
    
    navigator.clipboard.writeText(areaNotas.value)
        .then(() => {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Copiado!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        })
        .catch(err => {
            console.error('Erro ao copiar:', err);
            alert('Erro ao copiar. Tente manualmente (Ctrl+C).');
        });
}

// FUN√á√ÉO PUBLICAR TELEGRAPH COM MELHOR TRATAMENTO DE ERRO
async function publicarTelegraph() {
    const conteudo = document.getElementById('area-notas').value;
    
    if (!conteudo.trim()) {
        alert("O conte√∫do est√° vazio. Escreva algo antes de publicar!");
        return;
    }

    const btn = event.target;
    const iconOriginal = btn.innerHTML;
    btn.innerHTML = '<span>‚è≥</span> Publicando...';
    btn.disabled = true;

    try {
        console.log('üîß ========== IN√çCIO PUBLICA√á√ÉO TELEGRAPH ==========');
        console.log('1. Formatando conte√∫do para Telegraph...');
        
        // Remova o markdown e envie texto puro para simplificar
        // Primeiro, converta apenas quebras de linha em par√°grafos
        const paragraphs = conteudo.split('\n').filter(p => p.trim() !== "");
        console.log(`2. Criado ${paragraphs.length} par√°grafos do texto.`);
        
        // PASSO 1: Criar conta an√¥nima
        console.log('3. Criando conta an√¥nima no Telegraph...');
        const accountResponse = await fetch('https://api.telegra.ph/createAccount?short_name=MySword&author_name=AssistenteTeologico');
        
        console.log('4. Resposta da cria√ß√£o de conta recebida:', accountResponse.status);
        
        if (!accountResponse.ok) {
            const errorText = await accountResponse.text();
            console.error('Erro na resposta da conta:', errorText);
            throw new Error(`HTTP ${accountResponse.status} ao criar conta: ${errorText.substring(0, 100)}`);
        }
        
        const accountData = await accountResponse.json();
        console.log('5. Dados da conta recebidos:', accountData.ok ? '‚úÖ OK' : '‚ùå ERRO');
        
        if (!accountData.ok) {
            throw new Error(`API Telegraph: ${accountData.error || 'Erro desconhecido ao criar conta'}`);
        }
        
        const accessToken = accountData.result.access_token;
        console.log('6. Token de acesso obtido (primeiros 10 chars):', accessToken.substring(0, 10) + '...');
        
        // Crie os n√≥s de conte√∫do de forma mais simples e segura
        const contentNodes = paragraphs.map(p => ({
            tag: 'p',
            children: [p.replace(/\*\*(.*?)\*\*/g, '$1').replace(/\*(.*?)\*/g, '$1')]
        }));
        
        console.log('7. Estrutura dos n√≥s a serem enviados:', JSON.stringify(contentNodes).substring(0, 200) + '...');
        
        // PASSO 2: Criar a p√°gina
        console.log('8. Enviando requisi√ß√£o para criar p√°gina...');
        const pageResponse = await fetch(`https://api.telegra.ph/createPage`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                access_token: accessToken,
                title: "Estudo Teol√≥gico - MySword",
                author_name: "Assistente Teol√≥gico",
                content: contentNodes,
                return_content: false // Mude para false para simplificar
            })
        });
        
        console.log('9. Resposta da cria√ß√£o de p√°gina recebida:', pageResponse.status);
        
        const responseText = await pageResponse.text();
        console.log('10. Texto bruto da resposta:', responseText.substring(0, 300));
        
        if (!pageResponse.ok) {
            console.error('Resposta de erro completa:', responseText);
            throw new Error(`HTTP ${pageResponse.status}: ${responseText.substring(0, 150)}`);
        }
        
        const pageData = JSON.parse(responseText);
        console.log('11. Dados da p√°gina analisados:', pageData.ok ? '‚úÖ OK' : '‚ùå ERRO');
        
        if (pageData.ok) {
            const urlFinal = pageData.result.url;
            console.log('‚úÖ Publica√ß√£o bem-sucedida! URL:', urlFinal);
            
            // Mostrar resultado
            const chatContent = document.getElementById('chat-content');
            const resultHTML = `
                <div style="padding: 20px; background: rgba(0, 136, 204, 0.1); border-radius: 10px; margin-top: 15px; border: 1px solid #0088cc;">
                    <h4 style="color: #0088cc; margin-top: 0;">‚úÖ Publicado com Sucesso!</h4>
                    <p style="color: #fff; margin: 10px 0;">Sua p√°gina foi publicada no Telegraph.</p>
                    <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
                        <input type="text" id="telegraph-url" value="${urlFinal}" readonly 
                               style="flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 6px; color: #fff; font-size: 14px;">
                        <button onclick="copiarTelegraphUrl()" style="padding: 10px 15px; background: #30d158; color: white; border: none; border-radius: 6px; cursor: pointer;">üìã</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="window.open('${urlFinal}', '_blank')" style="flex: 1; padding: 12px; background: #0088cc; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            üîó Abrir P√°gina
                        </button>
                        <button onclick="shareTelegraph('${urlFinal}')" style="flex: 1; padding: 12px; background: #5856d6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            üì§ Compartilhar
                        </button>
                    </div>
                </div>
            `;
            
            // Inserir resultado ap√≥s o textarea
            const textarea = document.getElementById('area-notas');
            const buttonsDiv = textarea.nextElementSibling;
            buttonsDiv.insertAdjacentHTML('afterend', resultHTML);
            
        } else {
            throw new Error(`API Telegraph: ${pageData.error || 'Erro desconhecido ao criar p√°gina'}`);
        }

    } catch (error) {
        console.error("‚ùå ERRO DETALHADO na API do Telegraph:", error);
        console.error("Stack trace:", error.stack);
        
        // Mostrar erro mais informativo para o usu√°rio
        let mensagemErro = `Erro ao publicar: ${error.message}`;
        
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            mensagemErro += '\n\nüîç Poss√≠vel problema de conex√£o. Verifique sua internet ou se o site telegra.ph est√° acess√≠vel.';
        } else if (error.message.includes('429')) {
            mensagemErro += '\n\n‚ö†Ô∏è Muitas requisi√ß√µes. O Telegraph pode ter limitado requisi√ß√µes temporariamente. Tente novamente em alguns minutos.';
        } else if (error.message.includes('500') || error.message.includes('502')) {
            mensagemErro += '\n\n‚öôÔ∏è Problema no servidor do Telegraph. O servi√ßo pode estar inst√°vel no momento.';
        } else if (error.message.includes('CORS')) {
            mensagemErro += '\n\nüõ°Ô∏è Problema de CORS. Tente usar uma extens√£o para desabilitar CORS ou teste em outro navegador.';
        }
        
        alert(mensagemErro);
        
        // Tamb√©m mostrar erro na interface
        const chatContent = document.getElementById('chat-content');
        const errorHTML = `
            <div style="padding: 15px; background: rgba(255, 69, 58, 0.1); border-radius: 10px; margin-top: 15px; border: 1px solid #ff453a;">
                <h4 style="color: #ff453a; margin-top: 0;">‚ùå Falha na Publica√ß√£o</h4>
                <p style="color: #fff; margin: 10px 0; font-size: 14px;">${error.message.replace(/\n/g, '<br>')}</p>
                <p style="color: #ff9c7c; font-size: 12px; margin: 5px 0;">
                    üîç Abra o Console do navegador (F12 ‚Üí Console) para ver detalhes t√©cnicos.<br>
                    üí° Dica: Tente usar um texto mais curto e simples para teste.
                </p>
                <button onclick="testarConexaoTelegraph()" style="margin-top: 10px; padding: 8px 12px; background: #ff6b35; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
                    üß™ Testar Conex√£o com Telegraph
                </button>
            </div>
        `;
        
        const textarea = document.getElementById('area-notas');
        const buttonsDiv = textarea.nextElementSibling;
        buttonsDiv.insertAdjacentHTML('afterend', errorHTML);
        
    } finally {
        btn.innerHTML = iconOriginal;
        btn.disabled = false;
        console.log('üîß ========== FIM PUBLICA√á√ÉO TELEGRAPH ==========');
    }
}

// Fun√ß√£o para testar conex√£o com Telegraph
async function testarConexaoTelegraph() {
    console.log('üß™ Testando conex√£o com Telegraph API...');
    
    try {
        const testResponse = await fetch('https://api.telegra.ph/createAccount?short_name=TesteConexao');
        console.log('Status da resposta:', testResponse.status);
        console.log('Headers:', [...testResponse.headers.entries()]);
        
        const testText = await testResponse.text();
        console.log('Resposta bruta:', testText.substring(0, 200));
        
        if (testResponse.ok) {
            alert('‚úÖ Conex√£o com Telegraph OK! O problema pode estar no conte√∫do ou no formato dos dados.');
        } else {
            alert(`‚ùå Problema de conex√£o: HTTP ${testResponse.status}. O Telegraph pode estar indispon√≠vel.`);
        }
    } catch (error) {
        console.error('Erro no teste de conex√£o:', error);
        alert('‚ùå N√£o foi poss√≠vel conectar ao Telegraph. Verifique sua conex√£o com a internet.');
    }
}

// Fun√ß√£o para copiar URL do Telegraph
function copiarTelegraphUrl() {
    const urlInput = document.getElementById('telegraph-url');
    if (!urlInput) return;
    
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // Para mobile
    
    navigator.clipboard.writeText(urlInput.value)
        .then(() => {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        })
        .catch(err => {
            alert('Erro ao copiar. Tente manualmente (Ctrl+C).');
        });
}

// Fun√ß√£o para compartilhar via Web Share API
function shareTelegraph(url) {
    if (navigator.share) {
        navigator.share({
            title: 'Estudo Teol√≥gico - MySword',
            text: 'Confira este estudo teol√≥gico publicado via Telegraph',
            url: url
        })
        .catch(error => console.log('Erro ao compartilhar:', error));
    } else {
        // Fallback para copiar URL
        navigator.clipboard.writeText(url)
            .then(() => {
                alert('URL copiada para a √°rea de transfer√™ncia!');
            })
            .catch(err => {
                prompt('Copie a URL:', url);
            });
    }
}

// ============================================================================
// FUN√á√ïES DO CHAT COM FALLBACK
// ============================================================================
function limparTela() {
    document.getElementById("chat-content").innerHTML = "";
    document.getElementById("janela-chat").style.display = "flex";
}

function addMsg(e, t, model = null) {
    var n = document.createElement("div");
    n.className = "msg msg-" + t;
    
    if (t === "ai") {
        let modelBadge = '';
        if (model) {
            const config = aiConfig[model] || { name: model.toUpperCase(), color: '#8e8e93' };
            modelBadge = `<span class="badge" style="background: ${config.color}; margin-left: 8px;">${config.name}</span>`;
        }
        
        n.innerHTML = `<div style="color: #aaa; font-size: 12px; margin-bottom: 5px;">‚öîÔ∏è MySword AI ${modelBadge}</div>` + 
                      e.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>").replace(/\n/g, "<br>");
    } else {
        n.innerText = e;
    }
    
    var o = document.getElementById("chat-content");
    o.appendChild(n);
    o.scrollTop = o.scrollHeight;
    
    // Adicionar bot√£o de c√≥pia para mensagens da IA
    if (t === "ai") {
        var copyBtn = document.createElement("button");
        copyBtn.className = "btn-copy";
        copyBtn.innerText = "üìã COPIAR";
        copyBtn.onclick = function() {
            var textArea = document.createElement("textarea");
            textArea.value = e;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);
            copyBtn.innerText = "‚úÖ COPIADO!";
            setTimeout(() => { copyBtn.innerText = "üìã COPIAR"; }, 2000);
        };
        n.appendChild(copyBtn);
    }
    
    return n;
}

// ============================================================================
// SISTEMA DE FALLBACK AUTOM√ÅTICO
// ============================================================================
function updateApiQuotaStatus(provider, status, error = null) {
    if (error) {
        // Verificar se √© erro de cota (429)
        if (error.includes('429') || error.includes('quota') || error.includes('QUOTA')) {
            apiQuotaStatus[provider].available = false;
            apiQuotaStatus[provider].lastError = error;
            apiQuotaStatus[provider].retryAfter = Date.now() + 3600000; // 1 hora
            console.warn(`API ${provider} marcada como indispon√≠vel (cota excedida)`);
        }
    } else {
        apiQuotaStatus[provider].available = status;
        if (status) {
            apiQuotaStatus[provider].lastError = null;
            apiQuotaStatus[provider].retryAfter = null;
        }
    }
    
    // Salvar status no localStorage
    localStorage.setItem('mysword_api_quota_status', JSON.stringify(apiQuotaStatus));
    
    // Atualizar display
    updateAIStatusDisplay();
    updateAISelector();
}

// ============================================================================
// FUN√á√ïES DA API - COM SISTEMA DE FALLBACK
// ============================================================================
async function enviar() {
    const input = document.getElementById('prompt-input');
    const userText = input.value.trim();
    
    if (!userText) {
        alert("Digite uma pergunta!");
        return;
    }
    
    // Usar a IA selecionada
    const modelToUse = activeModel;
    
    // Verificar se h√° chave configurada
    if (!apiKeys[modelToUse]) {
        addMsg(`‚ö†Ô∏è ${aiConfig[modelToUse].name} n√£o est√° configurado. Configure a chave primeiro.`, "ai");
        showApiModal();
        selectApiProvider(modelToUse);
        return;
    }
    
    // Verificar se a IA est√° dispon√≠vel
    if (!apiQuotaStatus[modelToUse].available) {
        // Tentar pr√≥xima IA automaticamente
        const nextAI = getNextAvailableAI(modelToUse);
        if (nextAI && nextAI !== modelToUse) {
            if (confirm(`${aiConfig[modelToUse].name} pode estar indispon√≠vel. Usar ${aiConfig[nextAI].name} em vez disso?`)) {
                selectAI(nextAI);
                // Aguardar um momento para a mudan√ßa
                setTimeout(() => enviar(), 300);
                return;
            }
        }
    }
    
    // Mostrar janela de chat
    document.getElementById("janela-chat").style.display = "flex";
    
    // Adicionar mensagem do usu√°rio
    addMsg(userText, "user");
    input.value = "";
    
    // Adicionar mensagem de loading
    const loadingDiv = document.createElement("div");
    loadingDiv.className = "msg msg-ai";
    loadingDiv.innerHTML = `<div style="color: #aaa;">Pesquisando nas fontes assembleianas (usando ${aiConfig[modelToUse].name})...</div><div class="loading-ios"><span></span><span></span><span></span></div>`;
    document.getElementById("chat-content").appendChild(loadingDiv);
    
    try {
        let responseText = '';
        
        // Construir prompt completo
        let fullPrompt = defaultProfile;
        
        // Adicionar diretrizes do modo se selecionado
        if (modoAtual && modeGuidelines[modoAtual]) {
            fullPrompt += "\n\n" + modeGuidelines[modoAtual];
        }
        
        // Adicionar pergunta do usu√°rio
        fullPrompt += "\n\nPERGUNTA DO USU√ÅRIO: " + userText + "\n\nRESPONDA:";
        
        // Chamar API apropriada
        if (modelToUse === 'gemini') {
            responseText = await callGeminiAPI(fullPrompt);
        } else if (modelToUse === 'mistral') {
            responseText = await callMistralAPI(fullPrompt);
        } else if (modelToUse === 'deepseek') {
            responseText = await callDeepSeekAPI(fullPrompt);
        } else if (modelToUse === 'groq') {
            responseText = await callGroqAPI(fullPrompt);
        }
        
        // Remover loading e adicionar resposta
        loadingDiv.remove();
        addMsg(responseText, "ai", modelToUse);
        
        // Marcar API como funcionando
        updateApiQuotaStatus(modelToUse, true);
        
        // Salvar no hist√≥rico
        chatHistory.push({
            user: userText,
            ai: responseText,
            model: modelToUse,
            mode: modoAtual,
            timestamp: new Date().toISOString()
        });
        
        localStorage.setItem('mysword_chat_history', JSON.stringify(chatHistory));
        
    } catch (error) {
        loadingDiv.remove();
        
        // Verificar se √© erro de cota
        if (error.message.includes('429') || error.message.includes('quota') || error.message.includes('QUOTA')) {
            // Marcar API como indispon√≠vel
            updateApiQuotaStatus(modelToUse, false, error.message);
            
            // Tentar pr√≥xima API automaticamente
            const nextAI = getNextAvailableAI(modelToUse);
            if (nextAI && nextAI !== modelToUse) {
                addMsg(`‚ö†Ô∏è ${aiConfig[modelToUse].name} sem cota. Tentando ${aiConfig[nextAI].name} automaticamente...`, "ai");
                
                // Tentar novamente com pr√≥xima IA
                setTimeout(async () => {
                    try {
                        let retryResponse = '';
                        const retryPrompt = fullPrompt;
                        
                        if (nextAI === 'gemini') {
                            retryResponse = await callGeminiAPI(retryPrompt);
                        } else if (nextAI === 'mistral') {
                            retryResponse = await callMistralAPI(retryPrompt);
                        } else if (nextAI === 'deepseek') {
                            retryResponse = await callDeepSeekAPI(retryPrompt);
                        } else if (nextAI === 'groq') {
                            retryResponse = await callGroqAPI(retryPrompt);
                        }
                        
                        addMsg(retryResponse, "ai", nextAI);
                        updateApiQuotaStatus(nextAI, true);
                        
                        // Atualizar hist√≥rico
                        chatHistory.push({
                            user: userText,
                            ai: retryResponse,
                            model: nextAI,
                            mode: modoAtual,
                            timestamp: new Date().toISOString()
                        });
                        
                        localStorage.setItem('mysword_chat_history', JSON.stringify(chatHistory));
                    } catch (retryError) {
                        addMsg(`‚ùå Erro tamb√©m em ${aiConfig[nextAI].name}: ${retryError.message}`, "ai");
                    }
                }, 1000);
            } else {
                addMsg(`‚ùå ${aiConfig[modelToUse].name} sem cota e nenhuma IA alternativa dispon√≠vel. Configure outra IA.`, "ai");
            }
        } else {
            addMsg(`‚ùå Erro em ${aiConfig[modelToUse].name}: ${error.message}`, "ai");
        }
        
        console.error("Erro na API:", error);
    }
}

async function callGeminiAPI(prompt) {
    // Usar modelo descoberto ou padr√£o
    const modelName = discoveredModels.gemini || defaultModels.gemini;
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKeys.gemini}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 8192
                }
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            if (response.status === 429) {
                throw new Error('Cota gratuita do Gemini excedida (20 req/dia).');
            }
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || 'Sem resposta da API';
    } catch (error) {
        throw error;
    }
}

async function callMistralAPI(prompt) {
    // Usar modelo descoberto ou padr√£o
    const modelName = discoveredModels.mistral || defaultModels.mistral;
    try {
        const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKeys.mistral}`
            },
            body: JSON.stringify({
                model: modelName,
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.7,
                max_tokens: 8000
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            if (response.status === 429) {
                throw new Error('Limite de requisi√ß√µes do Mistral atingido (20 req/min).');
            }
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        return data.choices?.[0]?.message?.content || 'Sem resposta da API';
    } catch (error) {
        throw error;
    }
}

async function callDeepSeekAPI(prompt) {
    // Usar modelo descoberto ou padr√£o
    const modelName = discoveredModels.deepseek || defaultModels.deepseek;
    try {
        const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKeys.deepseek}`
            },
            body: JSON.stringify({
                model: modelName,
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.7,
                max_tokens: 8000
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            if (response.status === 429) {
                throw new Error('Limite tempor√°rio do DeepSeek atingido.');
            }
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        return data.choices?.[0]?.message?.content || 'Sem resposta da API';
    } catch (error) {
        throw error;
    }
}

async function callGroqAPI(prompt) {
    // Usar modelo descoberto ou padr√£o
    const modelName = discoveredModels.groq || defaultModels.groq;
    try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKeys.groq}`
            },
            body: JSON.stringify({
                model: modelName,
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.7,
                max_tokens: 8000
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            if (response.status === 429) {
                throw new Error('Cota do Groq excedida (~500 req/dia).');
            }
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        return data.choices?.[0]?.message?.content || 'Sem resposta da API';
    } catch (error) {
        throw error;
    }
}

// ============================================================================
// VERIFICA√á√ÉO DE STATUS DAS APIS
// ============================================================================
async function checkAllApiStatus() {
    const resultsContainer = document.getElementById('auto-config-results-ios');
    if (!resultsContainer) return;
    
    let html = '<div style="color: #aaa; font-size: 13px; text-align: center;">Verificando status das APIs...</div>';
    resultsContainer.innerHTML = html;
    
    const results = {};
    
    // Testar apenas APIs com chaves configuradas
    if (apiKeys.gemini) {
        results.gemini = await testApiStatus('gemini');
    }
    if (apiKeys.mistral) {
        results.mistral = await testApiStatus('mistral');
    }
    if (apiKeys.deepseek) {
        results.deepseek = await testApiStatus('deepseek');
    }
    if (apiKeys.groq) {
        results.groq = await testApiStatus('groq');
    }
    
    updateApiStatusDisplay(results);
}

async function testApiStatus(provider) {
    try {
        if (provider === 'gemini') {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKeys.gemini}`);
            if (!response.ok) {
                return { isValid: false, status: response.status };
            }
            return { isValid: true, status: 200 };
        } else if (provider === 'mistral') {
            const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKeys.mistral}`
                },
                body: JSON.stringify({
                    model: 'mistral-small-latest',
                    messages: [{ role: 'user', content: 'ping' }],
                    max_tokens: 1
                })
            });
            return { isValid: response.ok, status: response.status };
        } else if (provider === 'deepseek') {
            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKeys.deepseek}`
                },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages: [{ role: 'user', content: 'ping' }],
                    max_tokens: 1
                })
            });
            return { isValid: response.ok, status: response.status };
        } else if (provider === 'groq') {
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKeys.groq}`
                },
                body: JSON.stringify({
                    model: 'llama-3.1-8b-instant',
                    messages: [{ role: 'user', content: 'ping' }],
                    max_tokens: 1
                })
            });
            return { isValid: response.ok, status: response.status };
        }
    } catch (error) {
        return { isValid: false, status: error.message };
    }
}

function updateApiStatusDisplay(results) {
    const container = document.getElementById('auto-config-results-ios');
    if (!container) return;
    
    let html = '';
    let availableCount = 0;
    
    Object.keys(results).forEach(provider => {
        const result = results[provider];
        if (result.isValid) {
            availableCount++;
            html += `<div style="margin: 8px 0; padding: 8px; background: #238636; border-radius: 6px; color: white;">
                <strong>${provider.toUpperCase()}:</strong> ‚úÖ Dispon√≠vel
            </div>`;
            updateApiQuotaStatus(provider, true);
        } else {
            html += `<div style="margin: 8px 0; padding: 8px; background: #da3633; border-radius: 6px; color: white;">
                <strong>${provider.toUpperCase()}:</strong> ‚ùå Erro (Status: ${result.status})
            </div>`;
            updateApiQuotaStatus(provider, false, `Status: ${result.status}`);
        }
    });
    
    if (Object.keys(results).length === 0) {
        html = '<div style="color: #aaa; text-align: center;">‚ö†Ô∏è Nenhuma chave configurada para testar</div>';
    } else {
        html += `<div style="margin-top: 15px; padding: 10px; background: ${availableCount > 0 ? '#1a5fff' : '#da3633'}; border-radius: 8px; color: white; text-align: center;">
            ${availableCount} de ${Object.keys(results).length} APIs dispon√≠veis
        </div>`;
    }
    
    container.innerHTML = html;
    
    // Atualizar status das IAs
    updateAIStatusDisplay();
}

// ============================================================================
// FUN√á√ïES DO MODAL DE API
// ============================================================================
function showApiModal() {
    document.getElementById('api-modal-ios').style.display = 'flex';
    updateSavedKeysDisplay();
    
    // Preencher campos com chaves salvas
    document.getElementById('gemini-key-ios').value = apiKeys.gemini || '';
    document.getElementById('mistral-key-ios').value = apiKeys.mistral || '';
    document.getElementById('deepseek-key-ios').value = apiKeys.deepseek || '';
    document.getElementById('groq-key-ios').value = apiKeys.groq || '';
    
    // Verificar status automaticamente
    setTimeout(() => checkAllApiStatus(), 500);
}

function hideApiModal() {
    document.getElementById('api-modal-ios').style.display = 'none';
}

function selectApiProvider(provider) {
    apiProvider = provider;
    
    // Atualizar sele√ß√£o visual
    document.querySelectorAll('.api-option-ios').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.querySelector(`.${provider}`).classList.add('selected');
    
    // Mostrar configura√ß√£o apropriada
    document.getElementById('gemini-config-ios').style.display = 'none';
    document.getElementById('mistral-config-ios').style.display = 'none';
    document.getElementById('deepseek-config-ios').style.display = 'none';
    document.getElementById('groq-config-ios').style.display = 'none';
    
    document.getElementById(`${provider}-config-ios`).style.display = 'block';
}

function updateSavedKeysDisplay() {
    const container = document.getElementById('saved-keys-container-ios');
    container.innerHTML = '';
    
    let hasKeys = false;
    
    if (apiKeys.gemini) {
        hasKeys = true;
        const modelName = discoveredModels.gemini || 'modelo padr√£o';
        const status = apiQuotaStatus.gemini.available ? 'status-valid' : 'status-warning';
        const statusText = apiQuotaStatus.gemini.available ? '‚úì V√°lida' : '‚ö†Ô∏è Cota Baixa';
        container.innerHTML += `<div class="key-item-ios">
            <span><strong>Gemini:</strong> <span style="font-family: monospace;">${apiKeys.gemini.substring(0, 12)}...</span><br>
            <small style="color: #aaa;">Modelo: ${modelName}</small></span>
            <span class="key-status ${status}">${statusText}</span>
        </div>`;
    }
    
    if (apiKeys.mistral) {
        hasKeys = true;
        const modelName = discoveredModels.mistral || 'modelo padr√£o';
        const status = apiQuotaStatus.mistral.available ? 'status-valid' : 'status-invalid';
        container.innerHTML += `<div class="key-item-ios">
            <span><strong>Mistral:</strong> <span style="font-family: monospace;">${apiKeys.mistral.substring(0, 12)}...</span><br>
            <small style="color: #aaa;">Modelo: ${modelName}</small></span>
            <span class="key-status ${status}">${apiQuotaStatus.mistral.available ? '‚úì V√°lida' : '‚ùå Erro'}</span>
        </div>`;
    }
    
    if (apiKeys.deepseek) {
        hasKeys = true;
        const modelName = discoveredModels.deepseek || 'modelo padr√£o';
        const status = apiQuotaStatus.deepseek.available ? 'status-valid' : 'status-invalid';
        container.innerHTML += `<div class="key-item-ios">
            <span><strong>DeepSeek:</strong> <span style="font-family: monospace;">${apiKeys.deepseek.substring(0, 12)}...</span><br>
            <small style="color: #aaa;">Modelo: ${modelName}</small></span>
            <span class="key-status ${status}">${apiQuotaStatus.deepseek.available ? '‚úì V√°lida' : '‚ùå Erro'}</span>
        </div>`;
    }
    
    if (apiKeys.groq) {
        hasKeys = true;
        const modelName = discoveredModels.groq || 'modelo padr√£o';
        const status = apiQuotaStatus.groq.available ? 'status-valid' : 'status-invalid';
        container.innerHTML += `<div class="key-item-ios">
            <span><strong>Llama:</strong> <span style="font-family: monospace;">${apiKeys.groq.substring(0, 12)}...</span><br>
            <small style="color: #aaa;">Modelo: ${modelName}</small></span>
            <span class="key-status ${status}">${apiQuotaStatus.groq.available ? '‚úì V√°lida' : '‚ùå Erro'}</span>
        </div>`;
    }
    
    if (!hasKeys) {
        container.innerHTML = '<div class="key-item-ios"><span>üîë Nenhuma chave configurada ainda</span></div>';
    }
}

async function testApiKey(provider) {
    const keyInput = document.getElementById(`${provider}-key-ios`);
    const key = keyInput.value.trim();
    
    if (!key) {
        alert('‚ö†Ô∏è Insira uma chave primeiro!');
        return;
    }
    
    let isValid = false;
    let message = '';
    let modelName = '';
    
    try {
        if (provider === 'gemini') {
            const result = await testAndDiscoverGemini(key);
            isValid = result.isValid;
            message = isValid ? `‚úÖ Chave Gemini v√°lida! Modelo: ${result.model}` : `‚ùå Erro Gemini: ${result.error}`;
            modelName = result.model;
        } else if (provider === 'mistral') {
            const result = await testAndDiscoverMistral(key);
            isValid = result.isValid;
            message = isValid ? `‚úÖ Chave Mistral v√°lida! Modelo: ${result.model}` : `‚ùå Erro Mistral: ${result.error}`;
            modelName = result.model;
        } else if (provider === 'deepseek') {
            const result = await testAndDiscoverDeepSeek(key);
            isValid = result.isValid;
            message = isValid ? `‚úÖ Chave DeepSeek v√°lida! Modelo: ${result.model}` : `‚ùå Erro DeepSeek: ${result.error}`;
            modelName = result.model;
        } else if (provider === 'groq') {
            const result = await testAndDiscoverGroq(key);
            isValid = result.isValid;
            message = isValid ? `‚úÖ Chave Groq v√°lida! Modelo: ${result.model}` : `‚ùå Erro Groq: ${result.error}`;
            modelName = result.model;
        }
    } catch (e) {
        message = `‚ùå Erro ao testar: ${e.message}`;
    }
    
    alert(message);
    
    if (isValid) {
        apiKeys[provider] = key;
        if (modelName) discoveredModels[provider] = modelName;
        updateApiQuotaStatus(provider, true);
        updateSavedKeysDisplay();
        updateAIStatusDisplay();
        
        // Se for a primeira chave configurada, selecionar automaticamente
        if (Object.values(apiKeys).filter(k => k).length === 1) {
            selectAI(provider);
        }
    } else {
        updateApiQuotaStatus(provider, false, message);
        updateAIStatusDisplay();
    }
}

async function autoConfigAll() {
    const btn = document.querySelector('.modal-btn-ios.accent');
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Testando...';
    btn.disabled = true;
    
    const resultsContainer = document.getElementById('auto-config-results-ios');
    resultsContainer.innerHTML = '<div style="color: #aaa; text-align: center;">‚è≥ Testando todas as chaves...</div>';
    
    const geminiKey = document.getElementById('gemini-key-ios').value.trim();
    const mistralKey = document.getElementById('mistral-key-ios').value.trim();
    const deepseekKey = document.getElementById('deepseek-key-ios').value.trim();
    const groqKey = document.getElementById('groq-key-ios').value.trim();
    
    const results = {};
    
    // Testar todas as chaves em paralelo
    const promises = [];
    
    if (geminiKey) {
        promises.push(testAndDiscoverGemini(geminiKey).then(r => { results.gemini = r; }));
    }
    
    if (mistralKey) {
        promises.push(testAndDiscoverMistral(mistralKey).then(r => { results.mistral = r; }));
    }
    
    if (deepseekKey) {
        promises.push(testAndDiscoverDeepSeek(deepseekKey).then(r => { results.deepseek = r; }));
    }
    
    if (groqKey) {
        promises.push(testAndDiscoverGroq(groqKey).then(r => { results.groq = r; }));
    }
    
    // Aguardar todos os testes
    await Promise.all(promises);
    
    updateAutoConfigResults(results);
    
    btn.innerHTML = originalText;
    btn.disabled = false;
}

async function testAndDiscoverGemini(apiKey) {
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
        if (!response.ok) {
            if (response.status === 429) {
                return { isValid: false, error: "Cota excedida (20 req/dia)" };
            }
            return { isValid: false, error: `HTTP ${response.status}` };
        }
        
        const data = await response.json();
        if (data.models) {
            // Filtrar modelos Gemini
            const geminiModels = data.models.filter(m => 
                m.name.includes("gemini") && 
                m.supportedGenerationMethods && 
                m.supportedGenerationMethods.includes("generateContent")
            );
            
            if (geminiModels.length > 0) {
                // Ordenar pelo nome (mais recente primeiro)
                geminiModels.sort((a, b) => b.name.localeCompare(a.name));
                const chosenModel = geminiModels[0].name.replace("models/", "");
                discoveredModels.gemini = chosenModel;
                return { isValid: true, model: chosenModel };
            }
        }
        
        return { isValid: false, error: "Nenhum modelo Gemini encontrado" };
    } catch (error) {
        return { isValid: false, error: error.message };
    }
}

async function testAndDiscoverMistral(apiKey) {
    try {
        const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: 'mistral-small-latest',
                messages: [{ role: 'user', content: 'Test' }],
                max_tokens: 1
            })
        });
        
        if (!response.ok) {
            if (response.status === 429) {
                return { isValid: false, error: "Limite de 20 req/min atingido" };
            }
            return { isValid: false, error: `HTTP ${response.status}` };
        }
        
        discoveredModels.mistral = 'mistral-small-latest';
        return { isValid: true, model: 'mistral-small-latest' };
    } catch (error) {
        return { isValid: false, error: error.message };
    }
}

async function testAndDiscoverDeepSeek(apiKey) {
    try {
        const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: 'deepseek-chat',
                messages: [{ role: 'user', content: 'Test' }],
                max_tokens: 1
            })
        });
        
        if (!response.ok) {
            if (response.status === 429) {
                return { isValid: false, error: "Limite tempor√°rio atingido" };
            }
            return { isValid: false, error: `HTTP ${response.status}` };
        }
        
        discoveredModels.deepseek = 'deepseek-chat';
        return { isValid: true, model: 'deepseek-chat' };
    } catch (error) {
        return { isValid: false, error: error.message };
    }
}

async function testAndDiscoverGroq(apiKey) {
    try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: 'llama-3.1-8b-instant',
                messages: [{ role: 'user', content: 'Test' }],
                max_tokens: 1
            })
        });
        
        if (!response.ok) {
            if (response.status === 429) {
                return { isValid: false, error: "Cota de ~500 req/dia excedida" };
            }
            return { isValid: false, error: `HTTP ${response.status}` };
        }
        
        discoveredModels.groq = 'llama-3.1-8b-instant';
        return { isValid: true, model: 'llama-3.1-8b-instant' };
    } catch (error) {
        return { isValid: false, error: error.message };
    }
}

function updateAutoConfigResults(results) {
    const container = document.getElementById('auto-config-results-ios');
    if (!container) return;
    
    let html = '';
    let validCount = 0;
    
    // Verificar cada provedor
    const providers = ['gemini', 'mistral', 'deepseek', 'groq'];
    
    providers.forEach(provider => {
        if (results[provider]) {
            const result = results[provider];
            if (result.isValid) {
                validCount++;
                // Atualizar status da API
                updateApiQuotaStatus(provider, true);
                
                html += `<div style="margin: 8px 0; padding: 8px; background: #238636; border-radius: 6px; color: white;">
                    <strong>${provider.toUpperCase()}:</strong> ‚úÖ V√°lida | Modelo: ${result.model}
                </div>`;
            } else {
                // Atualizar status da API
                updateApiQuotaStatus(provider, false, result.error);
                
                html += `<div style="margin: 8px 0; padding: 8px; background: #da3633; border-radius: 6px; color: white;">
                    <strong>${provider.toUpperCase()}:</strong> ‚ùå ${result.error}
                </div>`;
            }
        }
    });
    
    if (Object.keys(results).length === 0) {
        html = '<div style="color: #aaa; text-align: center;">‚ö†Ô∏è Nenhuma chave para testar</div>';
    } else if (validCount > 0) {
        html += `<div style="margin-top: 15px; padding: 10px; background: #1a5fff; border-radius: 8px; color: white; text-align: center;">
            ‚úÖ ${validCount} de ${Object.keys(results).length} APIs configuradas com sucesso!
        </div>`;
        
        // Recomendar DeepSeek como padr√£o se estiver dispon√≠vel
        if (results.deepseek && results.deepseek.isValid) {
            html += `<div style="margin-top: 10px; padding: 8px; background: #238636; border-radius: 6px; color: white; text-align: center; font-size: 12px;">
                üöÄ <strong>DeepSeek recomendado como padr√£o</strong> (sem limites de cota)
            </div>`;
            selectAI('deepseek');
        }
    }
    
    container.innerHTML = html;
    
    // Salvar modelos descobertos
    localStorage.setItem('mysword_discovered_models', JSON.stringify(discoveredModels));
    
    // Atualizar display das chaves e status
    updateSavedKeysDisplay();
    updateAIStatusDisplay();
}

function saveAllApiKeys() {
    apiKeys.gemini = document.getElementById('gemini-key-ios').value.trim();
    apiKeys.mistral = document.getElementById('mistral-key-ios').value.trim();
    apiKeys.deepseek = document.getElementById('deepseek-key-ios').value.trim();
    apiKeys.groq = document.getElementById('groq-key-ios').value.trim();
    
    localStorage.setItem('mysword_api_keys', JSON.stringify(apiKeys));
    
    // Salvar modelos descobertos tamb√©m
    localStorage.setItem('mysword_discovered_models', JSON.stringify(discoveredModels));
    
    // Verificar status das APIs ap√≥s salvar
    setTimeout(() => checkAllApiStatus(), 1000);
    
    updateSavedKeysDisplay();
    updateAIStatusDisplay();
    hideApiModal();
    
    if (apiKeys.gemini || apiKeys.mistral || apiKeys.deepseek || apiKeys.groq) {
        addMsg('‚úÖ Chaves salvas com sucesso! Seletor de IA ativado.', 'ai');
    }
}

// ============================================================================
// BOT√ÉO PARA OBTER CHAVES GRATUITAS
// ============================================================================
function getFreeApiKeys() {
    const content = `
    <div style="padding: 20px; text-align: center;">
        <h3 style="color: var(--accent); margin-bottom: 20px;">üîë Como Obter Chaves Gratuitas</h3>
        
        <div style="text-align: left; margin-bottom: 20px;">
            <h4 style="color: var(--deepseek);">üß† DeepSeek (RECOMENDADO)</h4>
            <p style="font-size: 13px; color: #aaa;">
                1. Acesse: <a href="https://platform.deepseek.com/api_keys" target="_blank" style="color: #1a5fff;">DeepSeek Platform</a><br>
                2. Fa√ßa login (pode usar Google)<br>
                3. Clique em "Criar Nova Chave"<br>
                4. Copie a chave (come√ßa com "sk-")<br>
                <strong>‚úÖ Vantagem:</strong> Sem limites claros, totalmente gratuito
            </p>
        </div>
        
        <div style="text-align: left; margin-bottom: 20px;">
            <h4 style="color: var(--mistral);">üå™Ô∏è Mistral AI</h4>
            <p style="font-size: 13px; color: #aaa;">
                1. Acesse: <a href="https://console.mistral.ai/api-keys/" target="_blank" style="color: #6c47ff;">Mistral AI Platform</a><br>
                2. Crie conta gratuita<br>
                3. Gere sua chave API<br>
                4. Copie a chave<br>
                <strong>‚úÖ Vantagem:</strong> 20 requisi√ß√µes por minuto
            </p>
        </div>
        
        <div style="text-align: left; margin-bottom: 20px;">
            <h4 style="color: var(--groq);">ü¶ô Groq (Llama 3)</h4>
            <p style="font-size: 13px; color: #aaa;">
                1. Acesse: <a href="https://console.groq.com/keys" target="_blank" style="color: #f55325;">Groq Console</a><br>
                2. Fa√ßa login com Google<br>
                3. Copie sua chave (come√ßa com "gsk_")<br>
                <strong>‚úÖ Vantagem:</strong> Muito r√°pido, ~500 req/dia
            </p>
        </div>
        
        <div style="text-align: left; margin-bottom: 20px;">
            <h4 style="color: var(--gemini);">‚ú® Gemini (Google)</h4>
            <p style="font-size: 13px; color: #aaa;">
                1. Acesse: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #4285F4;">Google AI Studio</a><br>
                2. Fa√ßa login com Google<br>
                3. Clique em "Create API Key"<br>
                4. Copie a chave (come√ßa com "AIzaSy")<br>
                <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Apenas 20 requisi√ß√µes por dia
            </p>
        </div>
        
        <button class="modal-btn-ios" onclick="hideApiModal(); showApiModal();" style="margin-top: 20px;">
            üîë Voltar para Configura√ß√£o
        </button>
    </div>
    `;
    
    // Abrir em nova janela ou mostrar no modal
    const modalContent = document.querySelector('.modal-content-ios');
    modalContent.innerHTML = `
        <div class="modal-header-ios">
            <h3>üîë Como Obter Chaves Gratuitas</h3>
            <button class="close-btn-ios" onclick="hideApiModal(); showApiModal();">√ó</button>
        </div>
        ${content}
    `;
}

// ============================================================================
// TOGGLE HEADER COM DOUBLE TAP
// ============================================================================
let lastTap = 0;
document.body.addEventListener('click', function(e) {
    if (e.target.closest('#header-ai') || e.target.closest('button') || e.target.closest('input') || e.target.closest('#api-modal-ios')) {
        return;
    }
    
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;
    
    if (tapLength < 500 && tapLength > 0) {
        e.preventDefault();
        toggleHeader();
    }
    
    lastTap = currentTime;
});

function toggleHeader() {
    var h = document.getElementById('header-ai');
    var s = document.getElementById('espaco-topo');
    
    if (h.style.transform === 'translateY(-100%)') {
        h.style.transform = 'translateY(0)';
        s.style.height = '115px';
    } else {
        h.style.transform = 'translateY(-100%)';
        s.style.height = '0px';
    }
}

// ============================================================================
// FECHAR DROPDOWNS QUANDO CLICAR FORA
// ============================================================================
document.addEventListener('click', function(e) {
    const aiDropdown = document.getElementById('ai-dropdown');
    const aiSelector = document.getElementById('ai-selector');
    const modeDropdown = document.getElementById('mode-dropdown');
    const modeSelector = document.getElementById('mode-selector');
    
    if (aiDropdown.classList.contains('show') && 
        !aiDropdown.contains(e.target) && 
        !aiSelector.contains(e.target)) {
        aiDropdown.classList.remove('show');
    }
    
    if (modeDropdown.classList.contains('show') && 
        !modeDropdown.contains(e.target) && 
        !modeSelector.contains(e.target)) {
        modeDropdown.classList.remove('show');
    }
});
</script>
</body>
</html>
